// ==UserScript==
// @name         AIè‹±è¯­å­¦å›­ - åˆ’è¯æ”¶è—åŠ©æ‰‹
// @namespace    http://tampermonkey.net/
// @version      2.1
// @description  åœ¨ä»»æ„ç½‘é¡µåˆ’è¯ï¼Œä¸€é”®æ”¶è—åˆ°AIè‹±è¯­å­¦å›­å•è¯æœ¬
// @author       AIè‹±è¯­å­¦å›­
// @match        *://*/*
// @grant        GM_xmlhttpRequest
// @grant        GM_notification
// @grant        GM_setClipboard
// @require      https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js
// ==/UserScript==

(function() {
    'use strict';

    const API_KEY = 'sk-LaP3ofHPzUojd6JUzE9sqnbQprOeGyeXFaqe1v4rhg097kFq';
    const API_URL = 'https://api.moonshot.cn/v1';

    const toolbar = document.createElement('div');
    toolbar.id = 'word-collector-toolbar';
    toolbar.style.cssText = `
        position: fixed;
        background: rgba(102, 126, 234, 0.95);
        color: white;
        padding: 8px 12px;
        border-radius: 8px;
        font-size: 14px;
        z-index: 999999;
        display: none;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        backdrop-filter: blur(4px);
    `;
    toolbar.innerHTML = 'ğŸ“š æ”¶è—å•è¯';
    document.body.appendChild(toolbar);

    let selectedText = '';
    
    document.addEventListener('mouseup', function(e) {
        const selection = window.getSelection();
        selectedText = selection.toString().trim();
        
        if (selectedText.length > 0 && selectedText.length < 50) {
            if (/^[a-zA-Z\s-]+$/.test(selectedText)) {
                const range = selection.getRangeAt(0);
                const rect = range.getBoundingClientRect();
                
                toolbar.style.display = 'block';
                toolbar.style.left = rect.left + 'px';
                toolbar.style.top = (rect.top - 40) + 'px';
            } else {
                toolbar.style.display = 'none';
            }
        } else {
            toolbar.style.display = 'none';
        }
    });

    toolbar.addEventListener('click', async function() {
        if (!selectedText) return;
        
        this.textContent = 'ğŸ”„ AIæŸ¥è¯¢ä¸­...';
        this.style.pointerEvents = 'none';
        
        try {
            const wordDetails = await getWordDetails(selectedText);
            saveWordToLocal(wordDetails);
            
            GM_notification({
                title: 'å•è¯å·²æ”¶è—',
                text: `${wordDetails.word} - ${wordDetails.meaning}`,
                image: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg==',
                timeout: 4000
            });
            
            GM_setClipboard(`${wordDetails.word}: ${wordDetails.meaning}`);
            this.textContent = 'âœ… æ”¶è—æˆåŠŸ';
            this.style.background = 'rgba(76, 175, 80, 0.95)';
            
        } catch (error) {
            console.error('æ”¶è—å¤±è´¥:', error);
            this.textContent = 'âŒ æ”¶è—å¤±è´¥';
            this.style.background = 'rgba(244, 67, 54, 0.95)';
            
            GM_notification({
                title: 'æ”¶è—å¤±è´¥',
                text: error.message,
                timeout: 4000
            });
        }
        
        setTimeout(() => {
            this.textContent = 'ğŸ“š æ”¶è—å•è¯';
            this.style.background = 'rgba(102, 126, 234, 0.95)';
            this.style.pointerEvents = 'auto';
            this.style.display = 'none';
        }, 2000);
    });

    async function getWordDetails(word) {
        const cached = JSON.parse(localStorage.getItem('wordCache') || '{}');
        if (cached[word]) {
            return cached[word];
        }
        
        try {
            const messages = [{
                role: 'user',
                content: `è¯·æä¾›è‹±è¯­å•è¯"${word}"çš„è¯¦ç»†ä¿¡æ¯ï¼Œè¿”å›ä¸¥æ ¼çš„JSONæ ¼å¼ï¼š
{
  "word": "å•è¯æœ¬èº«",
  "phonetic": "éŸ³æ ‡",
  "meaning": "ä¸­æ–‡é‡Šä¹‰",
  "example": "å®ç”¨ä¾‹å¥",
  "category": "åˆ†ç±»ï¼ˆdaily/business/travel/academic/techï¼‰",
  "difficulty": "éš¾åº¦ï¼ˆeasy/medium/hardï¼‰"
}

è¯·ç¡®ä¿JSONæ ¼å¼æ­£ç¡®ï¼Œä¸è¦æœ‰ä»»ä½•é¢å¤–æ–‡æœ¬æˆ–æ³¨é‡Šã€‚`
            }];
            
            const content = await callKimiAPI(messages, 0.3);
            
            let wordDetails;
            try {
                const cleanedContent = content.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
                wordDetails = JSON.parse(cleanedContent);
            } catch {
                wordDetails = {
                    word: word,
                    phonetic: "/Ëˆ" + word.toLowerCase() + "/",
                    meaning: "æŸ¥è¯¢å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨æ·»åŠ ",
                    example: `This is a sample sentence with ${word}.`,
                    category: "daily",
                    difficulty: "medium"
                };
            }
            
            cached[word] = wordDetails;
            localStorage.setItem('wordCache', JSON.stringify(cached));
            
            return wordDetails;
        } catch (error) {
            console.error('å•è¯æŸ¥è¯¢å¤±è´¥:', error);
            return {
                word: word,
                phonetic: "/Ëˆ" + word.toLowerCase() + "/",
                meaning: "ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•",
                example: `This is a sample sentence with ${word}.`,
                category: "daily",
                difficulty: "medium"
            };
        }
    }

    async function callKimiAPI(messages, temperature = 0.3) {
        const apiKey = API_KEY;
        const apiUrl = 'https://api.moonshot.cn/v1/chat/completions';
        
        try {
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${apiKey}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    model: 'moonshot-v1-8k',
                    messages: messages,
                    temperature: temperature,
                    stream: false
                })
            });
            
            if (!response.ok) {
                throw new Error(`APIè°ƒç”¨å¤±è´¥: ${response.status} ${response.statusText}`);
            }
            
            const data = await response.json();
            return data.choices[0].message.content;
        } catch (error) {
            console.error('Kimi APIè°ƒç”¨å¤±è´¥:', error);
            throw error;
        }
    }

    function saveWordToLocal(wordDetails) {
        const wordDatabase = JSON.parse(localStorage.getItem('wordDatabase') || '[]');
        
        if (wordDatabase.find(w => w.word === wordDetails.word)) {
            throw new Error('å•è¯å·²å­˜åœ¨');
        }
        
        const newWord = {
            ...wordDetails,
            id: `${Date.now()}-${Math.random()}`,
            nextReview: Date.now(),
            reviewCount: 0,
            difficultyFactor: 2.5,
            status: 'new'
        };
        
        wordDatabase.push(newWord);
        localStorage.setItem('wordDatabase', JSON.stringify(wordDatabase));
        
        const today = new Date().toISOString().split('T')[0];
        const studyRecords = JSON.parse(localStorage.getItem('studyRecords') || '{}');
        studyRecords[today] = (studyRecords[today] || 0) + 1;
        localStorage.setItem('studyRecords', JSON.stringify(studyRecords));
    }

    document.addEventListener('keydown', function(e) {
        if (e.ctrlKey && e.shiftKey && e.key === 'S') {
            e.preventDefault();
            if (selectedText) {
                toolbar.click();
            }
        }
    });

    document.addEventListener('contextmenu', function(e) {
        const selection = window.getSelection();
        const word = selection.toString().trim();
        
        if (word.length > 0 && word.length < 50 && /^[a-zA-Z\s-]+$/.test(word)) {
            const menu = document.createElement('div');
            menu.style.cssText = `
                position: fixed;
                background: white;
                border: 1px solid #ddd;
                border-radius: 8px;
                padding: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 999999;
                cursor: pointer;
                font-size: 14px;
            `;
            menu.innerHTML = 'ğŸ“š æ”¶è—åˆ°AIè‹±è¯­å­¦å›­';
            menu.style.left = e.clientX + 'px';
            menu.style.top = e.clientY + 'px';
            
            document.body.appendChild(menu);
            
            menu.addEventListener('click', function() {
                selectedText = word;
                toolbar.click();
                menu.remove();
            });
            
            setTimeout(() => {
                document.addEventListener('click', function closeMenu() {
                    menu.remove();
                    document.removeEventListener('click', closeMenu);
                });
            }, 100);
            
            e.preventDefault();
        }
    });

    console.log('âœ… AIè‹±è¯­å­¦å›­ - åˆ’è¯æ”¶è—åŠ©æ‰‹å·²åŠ è½½');
    console.log('ğŸ“Œ ä½¿ç”¨æ–¹æ³•ï¼šåœ¨ä»»æ„ç½‘é¡µåˆ’é€‰è‹±æ–‡å•è¯ï¼Œç‚¹å‡»å‡ºç°çš„è“è‰²å·¥å…·æ å³å¯æ”¶è—');
})();
