<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIè‹±è¯­å­¦å›­ - Smart English</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* é¡¶éƒ¨å¯¼èˆª */
        .navbar {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 15px 30px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 24px;
            font-weight: bold;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .nav-links {
            display: flex;
            gap: 20px;
        }

        .nav-link {
            padding: 10px 20px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            color: #666;
            font-weight: 500;
        }

        .nav-link:hover, .nav-link.active {
            background: #667eea;
            color: white;
        }

        .progress-bar {
            width: 200px;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #4CAF50, #8BC34A);
            transition: width 0.3s;
        }

        /* ä¸»å†…å®¹åŒº */
        .page {
            display: none;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            min-height: 600px;
        }

        .page.active {
            display: block;
        }

        /* å•è¯å¡ç‰‡ */
        .word-card {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            margin: 20px 0;
            position: relative;
        }

        .word-title {
            font-size: 48px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .phonetic {
            font-size: 24px;
            color: #666;
            margin-bottom: 20px;
        }

        .word-meaning {
            font-size: 20px;
            margin-bottom: 20px;
            color: #333;
        }

        .word-example {
            font-size: 18px;
            font-style: italic;
            color: #555;
            padding: 20px;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 10px;
        }

        .difficulty-badge {
            position: absolute;
            top: 20px;
            right: 20px;
            padding: 5px 15px;
            border-radius: 15px;
            font-size: 14px;
            font-weight: bold;
        }

        .difficulty-easy { background: #4CAF50; color: white; }
        .difficulty-medium { background: #FF9800; color: white; }
        .difficulty-hard { background: #F44336; color: white; }

        /* æŒ‰é’®æ ·å¼ */
        .btn-group {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }

        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: #4CAF50;
            color: white;
        }

        .btn-warning {
            background: #FF9800;
            color: white;
        }

        .btn-danger {
            background: #F44336;
            color: white;
        }

        /* åˆ†ç±»é€‰æ‹©å™¨ */
        .category-selector {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .category-btn {
            padding: 10px 20px;
            border: 2px solid #667eea;
            background: white;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .category-btn:hover, .category-btn.active {
            background: #667eea;
            color: white;
        }

        /* è¿›åº¦æŒ‡ç¤ºå™¨ */
        .progress-indicator {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 20px 0;
        }

        .progress-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #e0e0e0;
            transition: all 0.3s;
        }

        .progress-dot.completed {
            background: #4CAF50;
        }

        /* AIè¾…åŠ©é¡µé¢ */
        .ai-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .ai-tab {
            padding: 10px 20px;
            background: #f0f0f0;
            border-radius: 10px;
            cursor: pointer;
        }

        .ai-tab.active {
            background: #667eea;
            color: white;
        }

        .ai-content {
            background: #f9f9f9;
            border-radius: 10px;
            padding: 20px;
            min-height: 400px;
        }

        .chat-message {
            margin: 10px 0;
            padding: 15px;
            border-radius: 10px;
        }

        .chat-message.ai {
            background: #e3f2fd;
            margin-right: 20%;
        }

        .chat-message.user {
            background: #f3e5f5;
            margin-left: 20%;
            text-align: right;
        }

        /* å•è¯åº“ */
        .word-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .word-item {
            background: #f5f5f5;
            border-radius: 10px;
            padding: 20px;
            transition: all 0.3s;
        }

        .word-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .mastery-bar {
            width: 100%;
            height: 6px;
            background: #e0e0e0;
            border-radius: 3px;
            margin-top: 10px;
            overflow: hidden;
        }

        .mastery-fill {
            height: 100%;
            background: linear-gradient(45deg, #4CAF50, #8BC34A);
            transition: width 0.3s;
        }

        /* å¤ä¹ é¡µé¢ */
        .review-card {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 20px;
            padding: 40px;
            margin: 20px 0;
        }

        .review-question {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 30px;
            text-align: center;
        }

        .review-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .review-option {
            padding: 20px;
            background: white;
            border: 2px solid transparent;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 18px;
        }

        .review-option:hover {
            border-color: #667eea;
            transform: scale(1.02);
        }

        .review-option.correct {
            border-color: #4CAF50;
            background: #e8f5e9;
        }

        .review-option.incorrect {
            border-color: #F44336;
            background: #ffebee;
        }

        /* è¿›åº¦å›¾è¡¨ */
        .chart-container {
            position: relative;
            height: 300px;
            margin: 20px 0;
        }

        /* è®¾ç½®é¢æ¿ */
        .settings-panel {
            background: #f5f5f5;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid #ddd;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .nav-links {
                flex-direction: column;
                gap: 10px;
            }
            
            .word-title {
                font-size: 36px;
            }
            
            .review-options {
                grid-template-columns: 1fr;
            }
        }

        /* å‘éŸ³æ§åˆ¶é¢æ¿ */
        .pronunciation-panel {
            background: #f5f5f5;
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .voice-selector {
            display: flex;
            gap: 10px;
        }

        .voice-btn {
            padding: 8px 15px;
            border: 1px solid #667eea;
            background: white;
            border-radius: 15px;
            cursor: pointer;
        }

        .voice-btn.active {
            background: #667eea;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- é¡¶éƒ¨å¯¼èˆª -->
        <nav class="navbar">
            <div class="logo">ğŸ¯ AIè‹±è¯­å­¦å›­</div>
            <div class="nav-links">
                <a href="#group" class="nav-link active" data-page="group">åˆ†ç»„å­¦ä¹ </a>
                <a href="#ai" class="nav-link" data-page="ai">AIè¾…åŠ©</a>
                <a href="#vocabulary" class="nav-link" data-page="vocabulary">å•è¯åº“</a>
                <a href="#review" class="nav-link" data-page="review">æ™ºèƒ½å¤ä¹ </a>
                <a href="#progress" class="nav-link" data-page="progress">å­¦ä¹ è¿›åº¦</a>
            </div>
            <div>
                <div style="font-size: 12px; color: #666;">ä»Šæ—¥ç›®æ ‡</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="dailyProgress" style="width: 0%"></div>
                </div>
            </div>
        </nav>

        <!-- åˆ†ç»„å­¦ä¹ é¡µ -->
        <div class="page active" id="group">
            <h2 style="text-align: center; margin-bottom: 30px;">ğŸ“š åˆ†ç»„å­¦ä¹ </h2>
            
            <div class="category-selector" id="categorySelector">
                <div class="category-btn active" data-category="daily">æ—¥å¸¸</div>
                <div class="category-btn" data-category="business">å•†åŠ¡</div>
                <div class="category-btn" data-category="travel">æ—…æ¸¸</div>
                <div class="category-btn" data-category="academic">å­¦æœ¯</div>
                <div class="category-btn" data-category="tech">æŠ€æœ¯</div>
            </div>

            <div class="progress-indicator" id="progressIndicator"></div>

            <div class="word-card" id="wordCard">
                <div class="difficulty-badge" id="difficultyBadge">Easy</div>
                <div class="word-title" id="wordTitle">Welcome</div>
                <div class="phonetic" id="phonetic">/ËˆwelkÉ™m/</div>
                <div class="word-meaning" id="wordMeaning">æ¬¢è¿</div>
                <div class="word-example" id="wordExample">Welcome to our AI English learning platform!</div>
                
                <div class="pronunciation-panel">
                    <select id="voiceSelect">
                        <option value="US">ç¾éŸ³</option>
                        <option value="UK">è‹±éŸ³</option>
                    </select>
                    <input type="range" id="rateSlider" min="0.5" max="2" step="0.1" value="1">
                    <span id="rateValue">1.0x</span>
                    <button class="btn btn-primary" onclick="speakWord()">ğŸ”Š å‘éŸ³</button>
                    <button class="btn btn-primary" onclick="speakExample()">ğŸ“– æœ—è¯»ä¾‹å¥</button>
                </div>
            </div>

            <div class="btn-group">
                <button class="btn btn-danger" onclick="markWord('unknown')">ä¸è®¤è¯†</button>
                <button class="btn btn-success" onclick="markWord('known')">è®¤è¯†</button>
                <button class="btn btn-warning" onclick="showAIDictionary()">AIè¯¦è§£</button>
                <button class="btn btn-primary" id="nextGroupBtn" onclick="nextGroup()" style="display:none;">ä¸‹ä¸€ç»„</button>
            </div>
        </div>

        <!-- AIè¾…åŠ©é¡µ -->
        <div class="page" id="ai">
            <h2 style="text-align: center; margin-bottom: 30px;">ğŸ¤– AIè¾…åŠ©å­¦ä¹ </h2>
            
            <div class="ai-tabs">
                <div class="ai-tab active" data-tab="dialogue">AIå¯¹è¯</div>
                <div class="ai-tab" data-tab="story">AIå°è¯´</div>
            </div>

            <div class="ai-content" id="aiContent">
                <div id="dialogueTab">
                    <div id="chatContainer" style="height: 400px; overflow-y: auto;">
                        <div class="chat-message ai">
                            ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„AIè‹±è¯­é™ªç»ƒã€‚è®©æˆ‘ä»¬ç”¨ä½ å­¦è¿‡çš„å•è¯æ¥èŠå¤©å§ï¼å›å¤æˆ‘ä»»æ„æ¶ˆæ¯å¼€å§‹å¯¹è¯ã€‚
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <input type="text" id="chatInput" style="flex: 1; padding: 10px; border-radius: 5px; border: 1px solid #ddd;">
                        <button class="btn btn-primary" onclick="sendChat()">å‘é€</button>
                    </div>
                </div>

                <div id="storyTab" style="display: none;">
                    <button class="btn btn-primary" onclick="generateStory()" style="margin-bottom: 20px;">ç”Ÿæˆä»Šæ—¥æ•…äº‹</button>
                    <div id="storyContainer" style="line-height: 1.8; font-size: 18px;"></div>
                </div>
            </div>
        </div>

        <!-- å•è¯åº“é¡µ -->
        <div class="page" id="vocabulary">
            <h2 style="text-align: center; margin-bottom: 30px;">ğŸ“– æˆ‘çš„å•è¯åº“</h2>
            
            <div style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
                <input type="text" id="searchInput" placeholder="æœç´¢å•è¯..." style="flex: 1; padding: 10px; border-radius: 5px; border: 1px solid #ddd;">
                <select id="filterCategory" style="padding: 10px; border-radius: 5px;">
                    <option value="">å…¨éƒ¨åˆ†ç±»</option>
                    <option value="daily">æ—¥å¸¸</option>
                    <option value="business">å•†åŠ¡</option>
                    <option value="travel">æ—…æ¸¸</option>
                    <option value="academic">å­¦æœ¯</option>
                    <option value="tech">æŠ€æœ¯</option>
                </select>
                <select id="filterDifficulty" style="padding: 10px; border-radius: 5px;">
                    <option value="">å…¨éƒ¨éš¾åº¦</option>
                    <option value="easy">ç®€å•</option>
                    <option value="medium">ä¸­ç­‰</option>
                    <option value="hard">å›°éš¾</option>
                </select>
                <button class="btn btn-primary" onclick="importCSV()">å¯¼å…¥CSV</button>
                <input type="file" id="csvFile" accept=".csv" style="display: none;" onchange="handleCSV(event)">
            </div>

            <div class="word-grid" id="wordGrid"></div>
        </div>

        <!-- æ™ºèƒ½å¤ä¹ é¡µ -->
        <div class="page" id="review">
            <h2 style="text-align: center; margin-bottom: 30px;">ğŸ”„ æ™ºèƒ½å¤ä¹ </h2>
            
            <div style="text-align: center; margin-bottom: 20px;">
                <div style="font-size: 24px; font-weight: bold;">
                    å¾…å¤ä¹ å•è¯: <span id="reviewCount">0</span>
                </div>
                <div style="color: #666;">åŸºäºé—´éš”é‡å¤ç®—æ³•(SRS)æ™ºèƒ½æ¨é€</div>
            </div>

            <div id="reviewArea">
                <div style="text-align: center; color: #999; padding: 100px 20px;">
                    ğŸ‰ æ­å–œï¼ä»Šæ—¥å¤ä¹ å·²å®Œæˆ
                    <br><br>
                    <button class="btn btn-primary" onclick="startReview()">å¼€å§‹å¤ä¹ </button>
                </div>
            </div>
        </div>

        <!-- å­¦ä¹ è¿›åº¦é¡µ -->
        <div class="page" id="progress">
            <h2 style="text-align: center; margin-bottom: 30px;">ğŸ“Š å­¦ä¹ è¿›åº¦</h2>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
                <div style="background: linear-gradient(45deg, #667eea, #764ba2); color: white; padding: 20px; border-radius: 10px; text-align: center;">
                    <div style="font-size: 36px; font-weight: bold;" id="totalWords">0</div>
                    <div>æ€»è¯æ±‡é‡</div>
                </div>
                <div style="background: linear-gradient(45deg, #4CAF50, #8BC34A); color: white; padding: 20px; border-radius: 10px; text-align: center;">
                    <div style="font-size: 36px; font-weight: bold;" id="todayLearned">0</div>
                    <div>ä»Šæ—¥å­¦ä¹ </div>
                </div>
                <div style="background: linear-gradient(45deg, #FF9800, #FFC107); color: white; padding: 20px; border-radius: 10px; text-align: center;">
                    <div style="font-size: 36px; font-weight: bold;" id="todayReviewed">0</div>
                    <div>ä»Šæ—¥å¤ä¹ </div>
                </div>
                <div style="background: linear-gradient(45deg, #F44336, #E91E63); color: white; padding: 20px; border-radius: 10px; text-align: center;">
                    <div style="font-size: 36px; font-weight: bold;" id="streakDays">0</div>
                    <div>è¿ç»­å¤©æ•°</div>
                </div>
            </div>

            <div class="chart-container">
                <canvas id="progressChart"></canvas>
            </div>

            <div class="settings-panel">
                <h3>âš™ï¸ è®¾ç½®</h3>
                <div class="setting-item">
                    <span>æ¯æ—¥å­¦ä¹ ç›®æ ‡</span>
                    <input type="number" id="dailyGoal" value="20" min="5" max="100" style="width: 80px; padding: 5px;">
                </div>
                <div class="setting-item">
                    <span>å¤ä¹ æé†’æ—¶é—´</span>
                    <input type="time" id="reminderTime" value="20:00">
                </div>
                <div class="setting-item">
                    <span>è‡ªåŠ¨å‘éŸ³</span>
                    <input type="checkbox" id="autoSpeak" checked>
                </div>
                <button class="btn btn-primary" onclick="saveSettings()">ä¿å­˜è®¾ç½®</button>
            </div>
        </div>
    </div>

    <!-- å¼•å…¥Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script>
        // ==================== å…¨å±€å˜é‡ ====================
        let currentGroup = [];
        let currentWordIndex = 0;
        let currentCategory = 'daily';
        let wordDatabase = JSON.parse(localStorage.getItem('wordDatabase') || '[]');
        let studyRecords = JSON.parse(localStorage.getItem('studyRecords') || '{}');
        let settings = JSON.parse(localStorage.getItem('settings') || '{"dailyGoal": 20, "reminderTime": "20:00", "voice": "US", "rate": 1.0}');
        let reviewQueue = [];
        let currentReviewWord = null;
        let synth = window.speechSynthesis;

        // ==================== æ¨¡æ‹Ÿå•è¯æ•°æ® ====================
        const mockWordGroups = {
            daily: [
                {word: "welcome", phonetic: "/ËˆwelkÉ™m/", meaning: "æ¬¢è¿", example: "Welcome to our home!", difficulty: "easy"},
                {word: "journey", phonetic: "/ËˆdÊ’ÉœËrni/", meaning: "æ—…ç¨‹", example: "Life is a long journey.", difficulty: "easy"},
                {word: "challenge", phonetic: "/ËˆtÊƒÃ¦lÉªndÊ’/", meaning: "æŒ‘æˆ˜", example: "Face the challenge bravely.", difficulty: "medium"},
                {word: "opportunity", phonetic: "/ËŒÉ‘ËpÉ™rËˆtuËnÉ™ti/", meaning: "æœºä¼š", example: "Every challenge is an opportunity.", difficulty: "medium"},
                {word: "experience", phonetic: "/ÉªkËˆspÉªriÉ™ns/", meaning: "ç»éªŒ", example: "Experience is the best teacher.", difficulty: "easy"},
                {word: "knowledge", phonetic: "/ËˆnÉ‘ËlÉªdÊ’/", meaning: "çŸ¥è¯†", example: "Knowledge is power.", difficulty: "easy"},
                {word: "achievement", phonetic: "/É™ËˆtÊƒiËvmÉ™nt/", meaning: "æˆå°±", example: "This is a great achievement.", difficulty: "medium"},
                {word: "dedication", phonetic: "/ËŒdedÉªËˆkeÉªÊƒn/", meaning: "å¥‰çŒ®", example: "Success requires dedication.", difficulty: "hard"},
                {word: "perseverance", phonetic: "/ËŒpÉœËrsÉ™ËˆvÉªrÉ™ns/", meaning: "æ¯…åŠ›", example: "Perseverance leads to success.", difficulty: "hard"},
                {word: "passion", phonetic: "/ËˆpÃ¦Êƒn/", meaning: "çƒ­æƒ…", example: "Follow your passion.", difficulty: "easy"}
            ],
            business: [
                {word: "negotiation", phonetic: "/nÉªËŒÉ¡oÊŠÊƒiËˆeÉªÊƒn/", meaning: "è°ˆåˆ¤", example: "The negotiation was successful.", difficulty: "medium"},
                {word: "investment", phonetic: "/ÉªnËˆvestmÉ™nt/", meaning: "æŠ•èµ„", example: "This is a good investment.", difficulty: "easy"},
                {word: "strategy", phonetic: "/ËˆstrÃ¦tÉ™dÊ’i/", meaning: "ç­–ç•¥", example: "We need a new strategy.", difficulty: "medium"},
                {word: "deadline", phonetic: "/ËˆdedlaÉªn/", meaning: "æˆªæ­¢æ—¥æœŸ", example: "The deadline is tomorrow.", difficulty: "easy"},
                {word: "collaboration", phonetic: "/kÉ™ËŒlÃ¦bÉ™ËˆreÉªÊƒn/", meaning: "åˆä½œ", example: "Collaboration is key to success.", difficulty: "hard"}
            ],
            travel: [
                {word: "adventure", phonetic: "/É™dËˆventÊƒÉ™r/", meaning: "å†’é™©", example: "Life is an adventure.", difficulty: "easy"},
                {word: "destination", phonetic: "/ËŒdestÉªËˆneÉªÊƒn/", meaning: "ç›®çš„åœ°", example: "What is your destination?", difficulty: "medium"},
                {word: "landscape", phonetic: "/ËˆlÃ¦ndskeÉªp/", meaning: "é£æ™¯", example: "The landscape is beautiful.", difficulty: "easy"},
                {word: "culture", phonetic: "/ËˆkÊŒltÊƒÉ™r/", meaning: "æ–‡åŒ–", example: "Experience the local culture.", difficulty: "medium"}
            ],
            academic: [
                {word: "hypothesis", phonetic: "/haÉªËˆpÉ‘ËÎ¸É™sÉªs/", meaning: "å‡è®¾", example: "The hypothesis needs testing.", difficulty: "hard"},
                {word: "methodology", phonetic: "/ËŒmeÎ¸É™ËˆdÉ‘ËlÉ™dÊ’i/", meaning: "æ–¹æ³•è®º", example: "What is your methodology?", difficulty: "hard"},
                {word: "citation", phonetic: "/saÉªËˆteÉªÊƒn/", meaning: "å¼•ç”¨", example: "Add a citation here.", difficulty: "medium"}
            ],
            tech: [
                {word: "algorithm", phonetic: "/ËˆÃ¦lÉ¡É™rÉªÃ°É™m/", meaning: "ç®—æ³•", example: "This algorithm is efficient.", difficulty: "medium"},
                {word: "innovation", phonetic: "/ËŒÉªnÉ™ËˆveÉªÊƒn/", meaning: "åˆ›æ–°", example: "Innovation drives progress.", difficulty: "medium"},
                {word: "network", phonetic: "/ËˆnetwÉœËrk/", meaning: "ç½‘ç»œ", example: "The network is down.", difficulty: "easy"}
            ]
        };

        // ==================== åˆå§‹åŒ– ====================
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            generateProgressIndicator();
            loadNewWordGroup();
            updateProgressStats();
            updateDailyProgress();
            setupNotification();
        });

        function initializeApp() {
            // è·¯ç”±åˆ‡æ¢
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const page = this.dataset.page;
                    switchPage(page);
                });
            });

            // åˆ†ç±»åˆ‡æ¢
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentCategory = this.dataset.category;
                    loadNewWordGroup();
                });
            });

            // AIæ ‡ç­¾åˆ‡æ¢
            document.querySelectorAll('.ai-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    document.querySelectorAll('.ai-tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    const tabName = this.dataset.tab;
                    document.getElementById('dialogueTab').style.display = tabName === 'dialogue' ? 'block' : 'none';
                    document.getElementById('storyTab').style.display = tabName === 'story' ? 'block' : 'none';
                });
            });

            // ç­›é€‰å™¨
            document.getElementById('searchInput').addEventListener('input', filterVocabulary);
            document.getElementById('filterCategory').addEventListener('change', filterVocabulary);
            document.getElementById('filterDifficulty').addEventListener('change', filterVocabulary);

            // è¯­é€Ÿè°ƒèŠ‚
            document.getElementById('rateSlider').addEventListener('input', function() {
                document.getElementById('rateValue').textContent = this.value + 'x';
                settings.rate = parseFloat(this.value);
                localStorage.setItem('settings', JSON.stringify(settings));
            });

            // åˆå§‹åŒ–å›¾è¡¨
            if (typeof Chart !== 'undefined') {
                initChart();
            }
        }

        function switchPage(pageName) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            
            document.getElementById(pageName).classList.add('active');
            document.querySelector(`[data-page="${pageName}"]`).classList.add('active');

            if (pageName === 'vocabulary') {
                renderVocabulary();
            } else if (pageName === 'review') {
                updateReviewCount();
            } else if (pageName === 'progress') {
                updateProgressStats();
            }
        }

        // ==================== å•è¯å­¦ä¹  ====================
        function loadNewWordGroup() {
            const words = mockWordGroups[currentCategory] || mockWordGroups.daily;
            currentGroup = words.slice(0, 10).map(w => ({
                ...w,
                id: `${Date.now()}-${Math.random()}`,
                category: currentCategory,
                nextReview: Date.now(),
                reviewCount: 0,
                difficultyFactor: 2.5,
                status: 'new'
            }));
            
            currentWordIndex = 0;
            document.getElementById('nextGroupBtn').style.display = 'none';
            showCurrentWord();
        }

        function showCurrentWord() {
            if (currentWordIndex >= currentGroup.length) {
                document.getElementById('wordCard').innerHTML = `
                    <div style="padding: 60px 20px; text-align: center;">
                        <h2>ğŸ‰ æœ¬ç»„å­¦ä¹ å®Œæˆï¼</h2>
                        <p>10ä¸ªå•è¯å·²åŠ å…¥ä½ çš„å•è¯åº“</p>
                        <button class="btn btn-primary" onclick="loadNewWordGroup()">å­¦ä¹ æ–°ä¸€ç»„</button>
                    </div>
                `;
                document.querySelector('.btn-group').style.display = 'none';
                groupCompleted();
                return;
            }

            const word = currentGroup[currentWordIndex];
            document.getElementById('wordTitle').textContent = word.word;
            document.getElementById('phonetic').textContent = word.phonetic;
            document.getElementById('wordMeaning').textContent = word.meaning;
            document.getElementById('wordExample').textContent = word.example;
            
            const badge = document.getElementById('difficultyBadge');
            badge.textContent = word.difficulty.toUpperCase();
            badge.className = `difficulty-badge difficulty-${word.difficulty}`;

            if (settings.autoSpeak) {
                setTimeout(() => speakWord(), 500);
            }

            updateProgressIndicator();
        }

        function markWord(status) {
            const word = currentGroup[currentWordIndex];
            word.status = status;
            
            if (status === 'known') {
                // æ·»åŠ åˆ°å•è¯åº“
                const existingIndex = wordDatabase.findIndex(w => w.word === word.word);
                if (existingIndex === -1) {
                    wordDatabase.push({...word});
                    localStorage.setItem('wordDatabase', JSON.stringify(wordDatabase));
                    
                    // æ›´æ–°å­¦ä¹ è®°å½•
                    const today = new Date().toISOString().split('T')[0];
                    studyRecords[today] = (studyRecords[today] || 0) + 1;
                    localStorage.setItem('studyRecords', JSON.stringify(studyRecords));
                }
            }

            currentWordIndex++;
            showCurrentWord();
        }

        function groupCompleted() {
            // å®Œæˆä¸€ç»„åè‡ªåŠ¨å¼€å§‹å¤ä¹ 
            setTimeout(() => {
                switchPage('review');
            }, 2000);
        }

        function nextGroup() {
            currentWordIndex = 0;
            showCurrentWord();
        }

        // ==================== å‘éŸ³åŠŸèƒ½ ====================
        function speakWord() {
            if (currentWordIndex < currentGroup.length) {
                speak(currentGroup[currentWordIndex].word);
            }
        }

        function speakExample() {
            if (currentWordIndex < currentGroup.length) {
                speak(currentGroup[currentWordIndex].example);
            }
        }

        function speak(text) {
            if (!synth) return;
            
            synth.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = settings.voice === 'UK' ? 'en-GB' : 'en-US';
            utterance.rate = settings.rate;
            utterance.pitch = 1;
            synth.speak(utterance);
        }

        // ==================== AIè¾…åŠ©åŠŸèƒ½ ====================
        function showAIDictionary() {
            if (currentWordIndex >= currentGroup.length) return;
            
            const word = currentGroup[currentWordIndex].word;
            const meaning = currentGroup[currentWordIndex].meaning;
            
            // æ¨¡æ‹ŸAIè¯å…¸
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; right: 0; bottom: 0; 
                background: rgba(0,0,0,0.5); display: flex; 
                justify-content: center; align-items: center; z-index: 1000;
            `;
            modal.innerHTML = `
                <div style="background: white; padding: 30px; border-radius: 15px; max-width: 600px; max-height: 80vh; overflow-y: auto;">
                    <h3>ğŸ” AIè¯å…¸ - ${word}</h3>
                    <div style="margin: 20px 0;">
                        <strong>é‡Šä¹‰ï¼š</strong>${meaning}
                    </div>
                    <div style="margin: 20px 0;">
                        <strong>åŒä¹‰è¯ï¼š</strong> ${generateSynonyms(word)}
                    </div>
                    <div style="margin: 20px 0;">
                        <strong>åä¹‰è¯ï¼š</strong> ${generateAntonyms(word)}
                    </div>
                    <div style="margin: 20px 0;">
                        <strong>è¯¦ç»†ç”¨æ³•ï¼š</strong> ${generateUsage(word)}
                    </div>
                    <button class="btn btn-primary" onclick="this.parentElement.parentElement.remove()">å…³é—­</button>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function generateSynonyms(word) {
            const synonyms = {
                'welcome': 'greet, receive, accept',
                'challenge': 'test, difficulty, obstacle',
                'opportunity': 'chance, possibility, opening'
            };
            return synonyms[word] || 'æš‚æ— å¯ç”¨çš„åŒä¹‰è¯æ•°æ®';
        }

        function generateAntonyms(word) {
            const antonyms = {
                'welcome': 'reject, refuse, bid farewell',
                'challenge': 'support, aid, assistance',
                'opportunity': 'obstacle, barrier, difficulty'
            };
            return antonyms[word] || 'æš‚æ— å¯ç”¨çš„åä¹‰è¯æ•°æ®';
        }

        function generateUsage(word) {
            return `è¿™æ˜¯ä¸€ä¸ª${word.length}ä¸ªå­—æ¯çš„å•è¯ï¼Œå¸¸ç”¨äºæ—¥å¸¸å¯¹è¯å’Œä¹¦é¢è¡¨è¾¾ã€‚å»ºè®®ç»“åˆä¾‹å¥è®°å¿†ï¼Œå¹¶å°è¯•åœ¨å£è¯­ä¸­ä¸»åŠ¨ä½¿ç”¨ã€‚`;
        }

        function sendChat() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            if (!message) return;

            addChatMessage(message, 'user');
            input.value = '';

            // æ¨¡æ‹ŸAIå›å¤
            setTimeout(() => {
                const learnedWords = wordDatabase.slice(-10).map(w => w.word);
                const response = generateAIResponse(message, learnedWords);
                addChatMessage(response, 'ai');
            }, 1000);
        }

        function addChatMessage(text, sender) {
            const container = document.getElementById('chatContainer');
            const msg = document.createElement('div');
            msg.className = `chat-message ${sender}`;
            msg.textContent = text;
            container.appendChild(msg);
            container.scrollTop = container.scrollHeight;
        }

        function generateAIResponse(userMessage, learnedWords) {
            if (learnedWords.length === 0) {
                return "ä½ è¿˜æ²¡æœ‰å­¦ä¹ ä»»ä½•å•è¯ï¼Œå¿«å»åˆ†ç»„å­¦ä¹ å§ï¼";
            }
            
            const randomWords = learnedWords.sort(() => 0.5 - Math.random()).slice(0, 3);
            return `Great! è®©æˆ‘ç”¨ä½ å­¦è¿‡çš„å•è¯æ¥å›å¤ï¼š${randomWords.join(', ')}. ç»§ç»­åŠ æ²¹ï¼ğŸ’ª`;
        }

        function generateStory() {
            const container = document.getElementById('storyContainer');
            container.innerHTML = '<div style="text-align: center;">ğŸ“ æ­£åœ¨ç”Ÿæˆæ•…äº‹...</div>';
            
            const todayWords = getTodayLearnedWords();
            if (todayWords.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #999;">ä»Šå¤©è¿˜æ²¡æœ‰å­¦ä¹ å•è¯ï¼Œå¿«å»åˆ†ç»„å­¦ä¹ å§ï¼</div>';
                return;
            }

            // æ¨¡æ‹ŸAIç”Ÿæˆæ•…äº‹
            setTimeout(() => {
                const story = generateMockStory(todayWords);
                container.innerHTML = story;
            }, 2000);
        }

        function getTodayLearnedWords() {
            const today = new Date().toISOString().split('T')[0];
            const count = studyRecords[today] || 0;
            return wordDatabase.slice(-count);
        }

        function generateMockStory(words) {
            if (words.length === 0) return "æš‚æ— å­¦ä¹ è®°å½•ã€‚";
            
            const wordTexts = words.map(w => `<strong>${w.word}</strong> (${w.meaning})`).join('ã€');
            
            return `
                <h3>ğŸ“– ä»Šæ—¥æ‰€å­¦å•è¯æ•…äº‹</h3>
                <div style="margin: 20px 0; line-height: 2;">
                    ä»Šå¤©ï¼Œæˆ‘è¸ä¸Šäº†ä¸€æ®µæ–°çš„<span style="color: #667eea;">journeyï¼ˆæ—…ç¨‹ï¼‰</span>ã€‚åœ¨è¿™ä¸ªå……æ»¡
                    <span style="color: #764ba2;">challengeï¼ˆæŒ‘æˆ˜ï¼‰</span>çš„ä¸–ç•Œé‡Œï¼Œæ¯ä¸€ä¸ª
                    <span style="color: #4CAF50;">opportunityï¼ˆæœºä¼šï¼‰</span>éƒ½å€¼å¾—çæƒœã€‚
                    <br><br>
                    é€šè¿‡ä¸æ–­çš„<span style="color: #FF9800;">experienceï¼ˆç»éªŒï¼‰</span>ç§¯ç´¯ï¼Œæˆ‘ä»¬è·å¾—å®è´µçš„
                    <span style="color: #F44336;">knowledgeï¼ˆçŸ¥è¯†ï¼‰</span>ã€‚è¿™æ­£æ˜¯æˆ‘ä»¬ä»Šå¤©å­¦ä¹ çš„æ ¸å¿ƒè¯æ±‡ï¼š
                    ${wordTexts}ã€‚
                    <br><br>
                    <button class="btn btn-primary" onclick="speakStory()">ğŸ”Š æœ—è¯»æ•…äº‹</button>
                    <button class="btn btn-success" onclick="downloadStory()">ğŸ’¾ ä¿å­˜æ•…äº‹</button>
                </div>
            `;
        }

        function speakStory() {
            const text = document.getElementById('storyContainer').textContent;
            speak(text);
        }

        function downloadStory() {
            const story = document.getElementById('storyContainer').innerHTML;
            const blob = new Blob([story], {type: 'text/html'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ä»Šæ—¥å•è¯æ•…äº‹_${new Date().toLocaleDateString()}.html`;
            a.click();
        }

        // ==================== é—´éš”é‡å¤ç®—æ³• ====================
        function calculateNextReview(word, quality) {
            // SM-2ç®—æ³•å®ç°
            if (!word.reviewCount) {
                word.reviewCount = 0;
                word.difficultyFactor = 2.5;
            }

            word.reviewCount++;
            
            if (quality >= 3) {
                if (word.reviewCount === 1) {
                    word.nextReview = Date.now() + 1 * 24 * 60 * 60 * 1000;
                } else if (word.reviewCount === 2) {
                    word.nextReview = Date.now() + 6 * 24 * 60 * 60 * 1000;
                } else {
                    const days = Math.round(word.difficultyFactor * (word.reviewCount === 3 ? 1 : word.difficultyFactor));
                    word.nextReview = Date.now() + days * 24 * 60 * 60 * 1000;
                }
            } else {
                // ç­”é”™å¤„ç†
                word.reviewCount = 0;
                word.nextReview = Date.now() + 1 * 60 * 60 * 1000; // 1å°æ—¶åå¤ä¹ 
                word.disabled = true; // åŠ å…¥å›°éš¾ç®±
            }

            // æ›´æ–°éš¾åº¦å› å­
            word.difficultyFactor = Math.max(1.3, word.difficultyFactor + (0.1 - (5 - quality) * (0.08 + (5 - quality) * 0.02)));
            
            return word;
        }

        // ==================== æ™ºèƒ½å¤ä¹  ====================
        function startReview() {
            updateReviewQueue();
            
            if (reviewQueue.length === 0) {
                document.getElementById('reviewArea').innerHTML = `
                    <div style="text-align: center; color: #999; padding: 100px 20px;">
                        ğŸ‰ æ­å–œï¼ä»Šæ—¥å¤ä¹ å·²å®Œæˆ
                        <br><br>
                        <button class="btn btn-primary" onclick="startReview()">åˆ·æ–°å¤ä¹ é˜Ÿåˆ—</button>
                    </div>
                `;
                return;
            }

            showReviewWord();
        }

        function updateReviewQueue() {
            const now = Date.now();
            reviewQueue = wordDatabase.filter(w => {
                if (w.disabled) {
                    // å›°éš¾ç®±ç‰¹æ®Šå¤„ç†
                    return (w.nextReview || 0) <= now || (w.reviewCount || 0) < 3;
                }
                return (w.nextReview || 0) <= now;
            }).sort((a, b) => (a.nextReview || 0) - (b.nextReview || 0));
        }

        function updateReviewCount() {
            updateReviewQueue();
            document.getElementById('reviewCount').textContent = reviewQueue.length;
        }

        function showReviewWord() {
            if (reviewQueue.length === 0) {
                startReview();
                return;
            }

            currentReviewWord = reviewQueue.shift();
            
            // ç”Ÿæˆé€‰æ‹©é¢˜
            const options = generateReviewOptions(currentReviewWord);
            const correctIndex = Math.floor(Math.random() * 4);
            
            const html = `
                <div class="review-card">
                    <div class="review-question">${currentReviewWord.word}</div>
                    <div class="review-options" id="reviewOptions">
                        ${options.map((opt, i) => `
                            <div class="review-option" onclick="selectReviewOption(${i === correctIndex ? 'true' : 'false'})">
                                ${opt}
                            </div>
                        `).join('')}
                    </div>
                    <div class="pronunciation-panel" style="justify-content: center;">
                        <button class="btn btn-primary" onclick="speak('${currentReviewWord.word}')">ğŸ”Š å‘éŸ³</button>
                    </div>
                </div>
            `;
            
            document.getElementById('reviewArea').innerHTML = html;
            
            // æ‰“ä¹±é€‰é¡¹
            const container = document.getElementById('reviewOptions');
            const shuffled = Array.from(container.children).sort(() => Math.random() - 0.5);
            shuffled.forEach(child => container.appendChild(child));
        }

        function generateReviewOptions(word) {
            const correct = word.meaning;
            const distractors = [
                `ä¸"${word.word}"æ‹¼å†™ç›¸ä¼¼çš„è¯ä¹‰`,
                `ä¸"${word.meaning}"ç›¸å…³çš„å¹²æ‰°é¡¹`,
                `éšæœºç”Ÿæˆçš„ç›¸è¿‘è¯ä¹‰`
            ];
            
            return [correct, ...distractors];
        }

        function selectReviewOption(isCorrect) {
            const options = document.querySelectorAll('.review-option');
            options.forEach(opt => {
                opt.style.pointerEvents = 'none';
                if (opt.onclick.toString().includes('true')) {
                    opt.classList.add('correct');
                } else if (opt === event.target) {
                    opt.classList.add('incorrect');
                }
            });

            // æ›´æ–°å•è¯æ•°æ®
            if (isCorrect) {
                calculateNextReview(currentReviewWord, 5);
                speak("Correct! Well done!");
                updateTodayReviewed();
                
                // æ£€æŸ¥å›°éš¾ç®±æ˜¯å¦è§£é™¤
                if (currentReviewWord.disabled && currentReviewWord.reviewCount >= 3) {
                    currentReviewWord.disabled = false;
                }
            } else {
                calculateNextReview(currentReviewWord, 2);
                speak("Incorrect. Let's review again.");
                
                // æ˜¾ç¤ºå¼ºåŒ–æç¤º
                setTimeout(() => {
                    showEnhancedReviewTip();
                }, 2000);
            }

            // ä¿å­˜æ›´æ–°
            const index = wordDatabase.findIndex(w => w.word === currentReviewWord.word);
            if (index !== -1) {
                wordDatabase[index] = currentReviewWord;
                localStorage.setItem('wordDatabase', JSON.stringify(wordDatabase));
            }

            // ä¸‹ä¸€é¢˜
            setTimeout(() => {
                saveReviewResult(isCorrect);
                showReviewWord();
            }, 3000);
        }

        function showEnhancedReviewTip() {
            const tip = document.createElement('div');
            tip.style.cssText = `
                background: #fff3cd;
                border: 1px solid #ffeaa7;
                border-radius: 10px;
                padding: 15px;
                margin: 20px;
            `;
            tip.innerHTML = `
                <strong>ğŸ’¡ å¼ºåŒ–è®°å¿†æç¤º</strong><br>
                "${currentReviewWord.word}" çš„æ„æ€æ˜¯ <strong>${currentReviewWord.meaning}</strong><br>
                <em>"${currentReviewWord.example}"</em>
            `;
            document.getElementById('reviewArea').appendChild(tip);
            
            setTimeout(() => tip.remove(), 3000);
        }

        function saveReviewResult(isCorrect) {
            // æ›´æ–°å¤ä¹ è®°å½•
            const today = new Date().toISOString().split('T')[0];
            if (!studyRecords.review) studyRecords.review = {};
            studyRecords.review[today] = (studyRecords.review[today] || 0) + 1;
            localStorage.setItem('studyRecords', JSON.stringify(studyRecords));
        }

        function updateTodayReviewed() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('todayReviewed').textContent = studyRecords.review?.[today] || 0;
        }

        // ==================== å•è¯åº“ç®¡ç† ====================
        function renderVocabulary() {
            const container = document.getElementById('wordGrid');
            const search = document.getElementById('searchInput').value.toLowerCase();
            const categoryFilter = document.getElementById('filterCategory').value;
            const difficultyFilter = document.getElementById('filterDifficulty').value;

            let filtered = wordDatabase.filter(w => {
                if (search && !w.word.includes(search) && !w.meaning.includes(search)) return false;
                if (categoryFilter && w.category !== categoryFilter) return false;
                if (difficultyFilter && w.difficulty !== difficultyFilter) return false;
                return true;
            });

            container.innerHTML = filtered.map(word => `
                <div class="word-item">
                    <h3>${word.word}</h3>
                    <div style="color: #666; font-size: 14px;">${word.phonetic}</div>
                    <div style="margin: 10px 0;">${word.meaning}</div>
                    <div style="font-size: 12px; color: #999;">
                        ${word.category} | ${word.difficulty}
                    </div>
                    <div class="mastery-bar">
                        <div class="mastery-fill" style="width: ${Math.min((word.reviewCount || 0) * 20, 100)}%"></div>
                    </div>
                    <div style="font-size: 12px; color: #666; margin-top: 5px;">
                        å¤ä¹ ${word.reviewCount || 0}æ¬¡
                    </div>
                    <div style="margin-top: 10px;">
                        <button class="btn btn-sm btn-primary" onclick="reviewWord('${word.word}')">å¤ä¹ </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteWord('${word.word}')">åˆ é™¤</button>
                    </div>
                </div>
            `).join('');
        }

        function filterVocabulary() {
            renderVocabulary();
        }

        function reviewWord(word) {
            switchPage('review');
            // å°†å•è¯åŠ å…¥å¤ä¹ é˜Ÿåˆ—å‰ç«¯
            const targetWord = wordDatabase.find(w => w.word === word);
            if (targetWord) {
                reviewQueue.unshift(targetWord);
            }
        }

        function deleteWord(word) {
            if (confirm(`ç¡®å®šè¦åˆ é™¤å•è¯ "${word}" å—ï¼Ÿ`)) {
                wordDatabase = wordDatabase.filter(w => w.word !== word);
                localStorage.setItem('wordDatabase', JSON.stringify(wordDatabase));
                renderVocabulary();
            }
        }

        function importCSV() {
            document.getElementById('csvFile').click();
        }

        function handleCSV(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const lines = e.target.result.split('\n');
                let imported = 0;
                
                lines.forEach(line => {
                    const parts = line.trim().split(',');
                    if (parts.length >= 5) {
                        const word = {
                            word: parts[0],
                            phonetic: parts[1],
                            meaning: parts[2],
                            example: parts[3],
                            category: parts[4],
                            difficulty: parts[5] || 'medium',
                            nextReview: Date.now(),
                            reviewCount: 0
                        };
                        
                        if (!wordDatabase.find(w => w.word === word.word)) {
                            wordDatabase.push(word);
                            imported++;
                        }
                    }
                });

                localStorage.setItem('wordDatabase', JSON.stringify(wordDatabase));
                alert(`æˆåŠŸå¯¼å…¥ ${imported} ä¸ªå•è¯ï¼`);
                renderVocabulary();
            };
            reader.readAsText(file);
        }

        // ==================== è¿›åº¦ç»Ÿè®¡ ====================
        function updateProgressStats() {
            document.getElementById('totalWords').textContent = wordDatabase.length;
            
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('todayLearned').textContent = studyRecords[today] || 0;
            document.getElementById('todayReviewed').textContent = studyRecords.review?.[today] || 0;
            
            // è®¡ç®—è¿ç»­å¤©æ•°
            let streak = 0;
            let checkDate = new Date();
            while (true) {
                const dateStr = checkDate.toISOString().split('T')[0];
                if (studyRecords[dateStr] || studyRecords.review?.[dateStr]) {
                    streak++;
                    checkDate.setDate(checkDate.getDate() - 1);
                } else {
                    break;
                }
            }
            document.getElementById('streakDays').textContent = streak;
        }

        function updateDailyProgress() {
            const today = new Date().toISOString().split('T')[0];
            const todayLearned = studyRecords[today] || 0;
            const progress = Math.min((todayLearned / settings.dailyGoal) * 100, 100);
            document.getElementById('dailyProgress').style.width = progress + '%';
        }

        let progressChart = null;

        function initChart() {
            const ctx = document.getElementById('progressChart').getContext('2d');
            const last7Days = getLast7DaysData();
            
            progressChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: last7Days.dates,
                    datasets: [{
                        label: 'å­¦ä¹ å•è¯æ•°',
                        data: last7Days.learned,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4
                    }, {
                        label: 'å¤ä¹ å•è¯æ•°',
                        data: last7Days.reviewed,
                        borderColor: '#4CAF50',
                        backgroundColor: 'rgba(76, 175, 80, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'æœ€è¿‘7å¤©å­¦ä¹ è¿›åº¦'
                        }
                    }
                }
            });
        }

        function getLast7DaysData() {
            const dates = [];
            const learned = [];
            const reviewed = [];
            
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];
                const shortDate = date.toLocaleDateString('zh-CN', {month: 'short', day: 'numeric'});
                
                dates.push(shortDate);
                learned.push(studyRecords[dateStr] || 0);
                reviewed.push(studyRecords.review?.[dateStr] || 0);
            }
            
            return {dates, learned, reviewed};
        }

        function saveSettings() {
            settings.dailyGoal = parseInt(document.getElementById('dailyGoal').value);
            settings.reminderTime = document.getElementById('reminderTime').value;
            settings.autoSpeak = document.getElementById('autoSpeak').checked;
            
            localStorage.setItem('settings', JSON.stringify(settings));
            alert('è®¾ç½®å·²ä¿å­˜ï¼');
            updateDailyProgress();
        }

        // ==================== é€šçŸ¥åŠŸèƒ½ ====================
        function setupNotification() {
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission();
            }
            
            // è®¾ç½®æ¯æ—¥æé†’
            const [hour, minute] = settings.reminderTime.split(':');
            const reminderTime = new Date();
            reminderTime.setHours(parseInt(hour), parseInt(minute), 0, 0);
            
            if (reminderTime > new Date()) {
                const timeout = reminderTime - new Date();
                setTimeout(() => {
                    if (Notification.permission === 'granted') {
                        new Notification('AIè‹±è¯­å­¦å›­', {
                            body: 'è¯¥å¤ä¹ å•è¯å•¦ï¼ä»Šå¤©çš„å­¦ä¹ ç›®æ ‡åœ¨ç­‰ç€ä½ ï¼',
                            icon: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg=='
                        });
                    }
                }, timeout);
            }
        }

        // ==================== å·¥å…·å‡½æ•° ====================
        function generateProgressIndicator() {
            const container = document.getElementById('progressIndicator');
            container.innerHTML = '';
            for (let i = 0; i < 10; i++) {
                const dot = document.createElement('div');
                dot.className = 'progress-dot';
                container.appendChild(dot);
            }
        }

        function updateProgressIndicator() {
            const dots = document.querySelectorAll('.progress-dot');
            dots.forEach((dot, i) => {
                if (i < currentWordIndex) {
                    dot.classList.add('completed');
                } else {
                    dot.classList.remove('completed');
                }
            });
        }

        // é˜²æ­¢é¡µé¢å…³é—­æ—¶ä¸¢å¤±æ•°æ®
        window.addEventListener('beforeunload', function() {
            localStorage.setItem('wordDatabase', JSON.stringify(wordDatabase));
            localStorage.setItem('studyRecords', JSON.stringify(studyRecords));
        });
    </script>
</body>
</html>
