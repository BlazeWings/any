<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIè‹±è¯­å­¦å›­ - Smart English</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* é¡¶éƒ¨å¯¼èˆª */
        .navbar {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 15px 30px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 24px;
            font-weight: bold;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .nav-links {
            display: flex;
            gap: 20px;
        }

        .nav-link {
            padding: 10px 20px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            color: #666;
            font-weight: 500;
        }

        .nav-link:hover, .nav-link.active {
            background: #667eea;
            color: white;
        }

        .progress-bar {
            width: 200px;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #4CAF50, #8BC34A);
            transition: width 0.3s;
        }

        /* ä¸»å†…å®¹åŒº */
        .page {
            display: none;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            min-height: 600px;
        }

        .page.active {
            display: block;
        }

        /* å•è¯å¡ç‰‡ */
        .word-card {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            margin: 20px 0;
            position: relative;
        }

        .word-title {
            font-size: 48px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .phonetic {
            font-size: 24px;
            color: #666;
            margin-bottom: 20px;
        }

        .word-meaning {
            font-size: 20px;
            margin-bottom: 20px;
            color: #333;
        }

        .word-example {
            font-size: 18px;
            font-style: italic;
            color: #555;
            padding: 20px;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 10px;
        }

        .difficulty-badge {
            position: absolute;
            top: 20px;
            right: 20px;
            padding: 5px 15px;
            border-radius: 15px;
            font-size: 14px;
            font-weight: bold;
        }

        .difficulty-easy { background: #4CAF50; color: white; }
        .difficulty-medium { background: #FF9800; color: white; }
        .difficulty-hard { background: #F44336; color: white; }

        /* æŒ‰é’®æ ·å¼ */
        .btn-group {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }

        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: #4CAF50;
            color: white;
        }

        .btn-warning {
            background: #FF9800;
            color: white;
        }

        .btn-danger {
            background: #F44336;
            color: white;
        }

        /* åˆ†ç±»é€‰æ‹©å™¨ */
        .category-selector {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .category-btn {
            padding: 10px 20px;
            border: 2px solid #667eea;
            background: white;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .category-btn:hover, .category-btn.active {
            background: #667eea;
            color: white;
        }

        /* éš¾åº¦é€‰æ‹©å™¨ */
        .difficulty-selector {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .difficulty-btn {
            padding: 8px 16px;
            border: 2px solid #4CAF50;
            background: white;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }

        .difficulty-btn:hover, .difficulty-btn.active {
            background: #4CAF50;
            color: white;
        }

        /* è¿›åº¦æŒ‡ç¤ºå™¨ */
        .progress-indicator {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 20px 0;
        }

        .progress-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #e0e0e0;
            transition: all 0.3s;
        }

        .progress-dot.completed {
            background: #4CAF50;
        }

        /* AIè¾…åŠ©é¡µé¢ */
        .ai-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .ai-tab {
            padding: 10px 20px;
            background: #f0f0f0;
            border-radius: 10px;
            cursor: pointer;
        }

        .ai-tab.active {
            background: #667eea;
            color: white;
        }

        .ai-content {
            background: #f9f9f9;
            border-radius: 10px;
            padding: 20px;
            min-height: 400px;
        }

        .chat-message {
            margin: 10px 0;
            padding: 15px;
            border-radius: 10px;
        }

        .chat-message.ai {
            background: #e3f2fd;
            margin-right: 20%;
        }

        .chat-message.user {
            background: #f3e5f5;
            margin-left: 20%;
            text-align: right;
        }

        /* å•è¯åº“ */
        .word-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .word-item {
            background: #f5f5f5;
            border-radius: 10px;
            padding: 20px;
            transition: all 0.3s;
        }

        .word-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .mastery-bar {
            width: 100%;
            height: 6px;
            background: #e0e0e0;
            border-radius: 3px;
            margin-top: 10px;
            overflow: hidden;
        }

        .mastery-fill {
            height: 100%;
            background: linear-gradient(45deg, #4CAF50, #8BC34A);
            transition: width 0.3s;
        }

        /* å¤ä¹ é¡µé¢ */
        .review-card {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 20px;
            padding: 40px;
            margin: 20px 0;
        }

        .review-question {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 30px;
            text-align: center;
        }

        .review-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .review-option {
            padding: 20px;
            background: white;
            border: 2px solid transparent;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 18px;
        }

        .review-option:hover {
            border-color: #667eea;
            transform: scale(1.02);
        }

        .review-option.correct {
            border-color: #4CAF50;
            background: #e8f5e9;
        }

        .review-option.incorrect {
            border-color: #F44336;
            background: #ffebee;
        }

        /* è¿›åº¦å›¾è¡¨ */
        .chart-container {
            position: relative;
            height: 300px;
            margin: 20px 0;
        }

        /* è®¾ç½®é¢æ¿ */
        .settings-panel {
            background: #f5f5f5;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid #ddd;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .nav-links {
                flex-direction: column;
                gap: 10px;
            }
            
            .word-title {
                font-size: 36px;
            }
            
            .review-options {
                grid-template-columns: 1fr;
            }
        }

        /* å‘éŸ³æ§åˆ¶é¢æ¿ */
        .pronunciation-panel {
            background: #f5f5f5;
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .voice-selector {
            display: flex;
            gap: 10px;
        }

        .voice-btn {
            padding: 8px 15px;
            border: 1px solid #667eea;
            background: white;
            border-radius: 15px;
            cursor: pointer;
        }

        .voice-btn.active {
            background: #667eea;
            color: white;
        }

        /* åŠ è½½åŠ¨ç”» */
        .loading-indicator {
            text-align: center;
            padding: 40px;
            color: #667eea;
        }

        .typing-dots::after {
            content: '';
            animation: typing 1.5s infinite;
        }

        @keyframes typing {
            0% { content: '.'; }
            33% { content: '..'; }
            66% { content: '...'; }
            100% { content: '.'; }
        }

        /* éš¾åº¦æ ‡ç­¾ */
        .difficulty-tag {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }

        .tag-cet4 { background: #4CAF50; color: white; }
        .tag-cet6 { background: #FF9800; color: white; }
        .tag-tem4 { background: #2196F3; color: white; }
        .tag-tem8 { background: #F44336; color: white; }

        /* é”™è¯¯æç¤º */
        .error-message {
            background: #ffebee;
            border: 1px solid #f44336;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            color: #f44336;
        }

        .success-message {
            background: #e8f5e9;
            border: 1px solid #4CAF50;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            color: #4CAF50;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- é¡¶éƒ¨å¯¼èˆª -->
        <nav class="navbar">
            <div class="logo">ğŸ¯ AIè‹±è¯­å­¦å›­</div>
            <div class="nav-links">
                <a href="#group" class="nav-link active" data-page="group">åˆ†ç»„å­¦ä¹ </a>
                <a href="#ai" class="nav-link" data-page="ai">AIè¾…åŠ©</a>
                <a href="#vocabulary" class="nav-link" data-page="vocabulary">å•è¯åº“</a>
                <a href="#review" class="nav-link" data-page="review">æ™ºèƒ½å¤ä¹ </a>
                <a href="#progress" class="nav-link" data-page="progress">å­¦ä¹ è¿›åº¦</a>
            </div>
            <div>
                <div style="font-size: 12px; color: #666;">ä»Šæ—¥ç›®æ ‡</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="dailyProgress" style="width: 0%"></div>
                </div>
            </div>
        </nav>

        <!-- åˆ†ç»„å­¦ä¹ é¡µ -->
        <div class="page active" id="group">
            <h2 style="text-align: center; margin-bottom: 30px;">ğŸ“š åˆ†ç»„å­¦ä¹ </h2>
            
            <!-- éš¾åº¦é€‰æ‹©å™¨ -->
            <div class="difficulty-selector">
                <div class="difficulty-btn active" data-difficulty="cet4">å››çº§</div>
                <div class="difficulty-btn" data-difficulty="cet6">å…­çº§</div>
                <div class="difficulty-btn" data-difficulty="tem4">ä¸“å››</div>
                <div class="difficulty-btn" data-difficulty="tem8">ä¸“å…«</div>
            </div>

            <!-- åˆ†ç±»é€‰æ‹©å™¨ -->
            <div class="category-selector" id="categorySelector">
                <div class="category-btn active" data-category="daily">æ—¥å¸¸</div>
                <div class="category-btn" data-category="business">å•†åŠ¡</div>
                <div class="category-btn" data-category="travel">æ—…æ¸¸</div>
                <div class="category-btn" data-category="academic">å­¦æœ¯</div>
                <div class="category-btn" data-category="tech">æŠ€æœ¯</div>
            </div>

            <!-- å­¦ä¹ çŠ¶æ€ä¿¡æ¯ -->
            <div id="learningStatus" style="text-align: center; margin-bottom: 20px; color: #666;">
                å·²å­¦å•è¯ï¼š<span id="learnedCount">0</span> | å½“å‰éš¾åº¦ï¼š<span id="currentDifficulty">å››çº§</span>
            </div>

            <div class="progress-indicator" id="progressIndicator"></div>

            <div class="word-card" id="wordCard">
                <div class="difficulty-badge" id="difficultyBadge">Easy</div>
                <div class="word-title" id="wordTitle">Welcome</div>
                <div class="phonetic" id="phonetic">/ËˆwelkÉ™m/</div>
                <div class="word-meaning" id="wordMeaning">æ¬¢è¿</div>
                <div class="word-example" id="wordExample">Welcome to our AI English learning platform!</div>
                
                <div class="pronunciation-panel">
                    <select id="voiceSelect">
                        <option value="US">ç¾éŸ³</option>
                        <option value="UK">è‹±éŸ³</option>
                    </select>
                    <input type="range" id="rateSlider" min="0.5" max="2" step="0.1" value="1">
                    <span id="rateValue">1.0x</span>
                    <button class="btn btn-primary" onclick="speakWord()">ğŸ”Š å‘éŸ³</button>
                    <button class="btn btn-primary" onclick="speakExample()">ğŸ“– æœ—è¯»ä¾‹å¥</button>
                </div>
            </div>

            <div class="btn-group">
                <button class="btn btn-danger" onclick="markWord('unknown')">ä¸è®¤è¯†</button>
                <button class="btn btn-success" onclick="markWord('known')">è®¤è¯†</button>
                <button class="btn btn-warning" onclick="showAIDictionary()">AIè¯¦è§£</button>
                <button class="btn btn-primary" id="nextGroupBtn" onclick="loadNewWordGroup()" style="display:none;">å­¦ä¹ æ–°ä¸€ç»„</button>
            </div>
        </div>

        <!-- AIè¾…åŠ©é¡µ -->
        <div class="page" id="ai">
            <h2 style="text-align: center; margin-bottom: 30px;">ğŸ¤– AIè¾…åŠ©å­¦ä¹ </h2>
            
            <div class="ai-tabs">
                <div class="ai-tab active" data-tab="dialogue">AIå¯¹è¯</div>
                <div class="ai-tab" data-tab="story">AIå°è¯´</div>
            </div>

            <div class="ai-content" id="aiContent">
                <div id="dialogueTab">
                    <div id="chatContainer" style="height: 400px; overflow-y: auto;">
                        <div class="chat-message ai">
                            ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„AIè‹±è¯­é™ªç»ƒã€‚è®©æˆ‘ä»¬ç”¨ä½ å­¦è¿‡çš„å•è¯æ¥èŠå¤©å§ï¼å›å¤æˆ‘ä»»æ„æ¶ˆæ¯å¼€å§‹å¯¹è¯ã€‚
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <input type="text" id="chatInput" style="flex: 1; padding: 10px; border-radius: 5px; border: 1px solid #ddd;">
                        <button class="btn btn-primary" onclick="sendChat()">å‘é€</button>
                    </div>
                </div>

                <div id="storyTab" style="display: none;">
                    <button class="btn btn-primary" onclick="generateStory()" style="margin-bottom: 20px;">ç”Ÿæˆä»Šæ—¥æ•…äº‹</button>
                    <div id="storyStatus" style="text-align: center; color: #666; margin-bottom: 15px;">
                        ä»Šæ—¥å·²å­¦å•è¯ï¼š<span id="todayWordsCount">0</span> ä¸ª
                    </div>
                    <div id="storyContainer" style="line-height: 1.8; font-size: 18px;"></div>
                </div>
            </div>
        </div>

        <!-- å•è¯åº“é¡µ -->
        <div class="page" id="vocabulary">
            <h2 style="text-align: center; margin-bottom: 30px;">ğŸ“– æˆ‘çš„å•è¯åº“</h2>
            
            <div style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
                <input type="text" id="searchInput" placeholder="æœç´¢å•è¯..." style="flex: 1; padding: 10px; border-radius: 5px; border: 1px solid #ddd;">
                <select id="filterCategory" style="padding: 10px; border-radius: 5px;">
                    <option value="">å…¨éƒ¨åˆ†ç±»</option>
                    <option value="daily">æ—¥å¸¸</option>
                    <option value="business">å•†åŠ¡</option>
                    <option value="travel">æ—…æ¸¸</option>
                    <option value="academic">å­¦æœ¯</option>
                    <option value="tech">æŠ€æœ¯</option>
                </select>
                <select id="filterDifficulty" style="padding: 10px; border-radius: 5px;">
                    <option value="">å…¨éƒ¨éš¾åº¦</option>
                    <option value="easy">ç®€å•</option>
                    <option value="medium">ä¸­ç­‰</option>
                    <option value="hard">å›°éš¾</option>
                </select>
                <button class="btn btn-primary" onclick="importCSV()">å¯¼å…¥CSV</button>
                <input type="file" id="csvFile" accept=".csv" style="display: none;" onchange="handleCSV(event)">
            </div>

            <div class="word-grid" id="wordGrid"></div>
        </div>

        <!-- æ™ºèƒ½å¤ä¹ é¡µ -->
        <div class="page" id="review">
            <h2 style="text-align: center; margin-bottom: 30px;">ğŸ”„ æ™ºèƒ½å¤ä¹ </h2>
            
            <div style="text-align: center; margin-bottom: 20px;">
                <div style="font-size: 24px; font-weight: bold;">
                    å¾…å¤ä¹ å•è¯: <span id="reviewCount">0</span>
                </div>
                <div style="color: #666;">åŸºäºé—´éš”é‡å¤ç®—æ³•(SRS)æ™ºèƒ½æ¨é€</div>
            </div>

            <div id="reviewArea">
                <div style="text-align: center; color: #999; padding: 100px 20px;">
                    ğŸ‰ æ­å–œï¼ä»Šæ—¥å¤ä¹ å·²å®Œæˆ
                    <br><br>
                    <button class="btn btn-primary" onclick="startReview()">å¼€å§‹å¤ä¹ </button>
                </div>
            </div>
        </div>

        <!-- å­¦ä¹ è¿›åº¦é¡µ -->
        <div class="page" id="progress">
            <h2 style="text-align: center; margin-bottom: 30px;">ğŸ“Š å­¦ä¹ è¿›åº¦</h2>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
                <div style="background: linear-gradient(45deg, #667eea, #764ba2); color: white; padding: 20px; border-radius: 10px; text-align: center;">
                    <div style="font-size: 36px; font-weight: bold;" id="totalWords">0</div>
                    <div>æ€»è¯æ±‡é‡</div>
                </div>
                <div style="background: linear-gradient(45deg, #4CAF50, #8BC34A); color: white; padding: 20px; border-radius: 10px; text-align: center;">
                    <div style="font-size: 36px; font-weight: bold;" id="todayLearned">0</div>
                    <div>ä»Šæ—¥å­¦ä¹ </div>
                </div>
                <div style="background: linear-gradient(45deg, #FF9800, #FFC107); color: white; padding: 20px; border-radius: 10px; text-align: center;">
                    <div style="font-size: 36px; font-weight: bold;" id="todayReviewed">0</div>
                    <div>ä»Šæ—¥å¤ä¹ </div>
                </div>
                <div style="background: linear-gradient(45deg, #F44336, #E91E63); color: white; padding: 20px; border-radius: 10px; text-align: center;">
                    <div style="font-size: 36px; font-weight: bold;" id="streakDays">0</div>
                    <div>è¿ç»­å¤©æ•°</div>
                </div>
            </div>

            <div class="chart-container">
                <canvas id="progressChart"></canvas>
            </div>

            <div class="settings-panel">
                <h3>âš™ï¸ è®¾ç½®</h3>
                <div class="setting-item">
                    <span>å­¦ä¹ éš¾åº¦</span>
                    <select id="difficultyLevel" style="padding: 5px;">
                        <option value="cet4">å¤§å­¦è‹±è¯­å››çº§</option>
                        <option value="cet6">å¤§å­¦è‹±è¯­å…­çº§</option>
                        <option value="tem4">è‹±è¯­ä¸“ä¸šå››çº§</option>
                        <option value="tem8">è‹±è¯­ä¸“ä¸šå…«çº§</option>
                    </select>
                </div>
                <div class="setting-item">
                    <span>æ¯æ—¥å­¦ä¹ ç›®æ ‡</span>
                    <input type="number" id="dailyGoal" value="20" min="5" max="100" style="width: 80px; padding: 5px;">
                </div>
                <div class="setting-item">
                    <span>å¤ä¹ æé†’æ—¶é—´</span>
                    <input type="time" id="reminderTime" value="20:00">
                </div>
                <div class="setting-item">
                    <span>è‡ªåŠ¨å‘éŸ³</span>
                    <input type="checkbox" id="autoSpeak" checked>
                </div>
                <button class="btn btn-primary" onclick="saveSettings()">ä¿å­˜è®¾ç½®</button>
            </div>
        </div>
    </div>

    <!-- å¼•å…¥Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script>
        // ==================== å…¨å±€å˜é‡ ====================
        let currentGroup = [];
        let currentWordIndex = 0;
        let currentCategory = 'daily';
        let difficultyLevel = 'cet4';
        let wordDatabase = JSON.parse(localStorage.getItem('wordDatabase') || '[]');
        let studyRecords = JSON.parse(localStorage.getItem('studyRecords') || '{}');
        let settings = JSON.parse(localStorage.getItem('settings') || '{"dailyGoal": 20, "reminderTime": "20:00", "voice": "US", "rate": 1.0, "difficultyLevel": "cet4"}');
        let reviewQueue = [];
        let currentReviewWord = null;
        let synth = window.speechSynthesis;
        let wordGenerationCache = {}; // æ–°å¢ï¼šå•è¯ç”Ÿæˆç¼“å­˜

        // ==================== Kimi API ç»Ÿä¸€è°ƒç”¨å‡½æ•° ====================
        async function callKimiAPI(messages, temperature = 0.3) {
            const apiKey = 'sk-LaP3ofHPzUojd6JUzE9sqnbQprOeGyeXFaqe1v4rhg097kFq';
            const apiUrl = 'https://api.moonshot.cn/v1/chat/completions';
            
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'moonshot-v1-8k',
                        messages: messages,
                        temperature: temperature,
                        stream: false
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`APIè°ƒç”¨å¤±è´¥: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                return data.choices[0].message.content;
            } catch (error) {
                console.error('Kimi APIè°ƒç”¨å¤±è´¥:', error);
                throw error;
            }
        }

        // ==================== AIç”Ÿæˆå•è¯ç»„åŠŸèƒ½ï¼ˆå¢å¼ºç‰ˆï¼‰ ====================
        async function generateNewWordGroup(category, difficulty) {
            const cacheKey = `${category}-${difficulty}`;
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            updateLearningStatus();
            
            // è·å–å·²å­¦è¿‡çš„å•è¯åˆ—è¡¨
            const learnedWords = wordDatabase.map(w => w.word);
            const learnedWordsStr = learnedWords.length > 0 ? learnedWords.join(', ') : 'æš‚æ— å·²å­¦å•è¯ï¼ˆé¦–æ¬¡å­¦ä¹ ï¼‰';
            
            const message = {
                role: 'user',
                content: `è¯·ç”Ÿæˆ10ä¸ªä¸é‡å¤çš„è‹±è¯­å•è¯ï¼Œè¦æ±‚ï¼š
1. éš¾åº¦çº§åˆ«ï¼š${difficultyLevelText(difficulty)}ï¼ˆ${difficulty}ï¼‰
2. åˆ†ç±»ï¼š${categoryText(category)}
3. æ ¼å¼è¦æ±‚ï¼šè¿”å›ä¸€ä¸ªJSONæ•°ç»„ï¼Œæ¯ä¸ªå…ƒç´ åŒ…å«ï¼šword, phonetic, meaning, example, difficulty
4. ç¡®ä¿è¿™äº›å•è¯å¸¸è§ä¸”å®ç”¨
5. ç»å¯¹ä¸èƒ½é‡å¤ç”¨æˆ·å·²å­¦è¿‡çš„å•è¯ï¼ˆç”¨æˆ·å·²å­¦è¿‡çš„å•è¯æœ‰ï¼š${learnedWordsStr}ï¼‰
6. å¦‚æœå·²å­¦å•è¯å¤ªå¤šï¼Œè¯·ä¼˜å…ˆç”Ÿæˆè¯¥éš¾åº¦ä¸‹å…¶ä»–å¸¸è§è¯æ±‡

è¯·åªè¿”å›JSONæ•°ç»„ï¼Œä¸è¦ä»»ä½•å…¶ä»–æ–‡æœ¬æˆ–æ³¨é‡Šã€‚ä¾‹å¦‚ï¼š
[
  {
    "word": "challenge",
    "phonetic": "/ËˆtÊƒÃ¦lÉªndÊ’/",
    "meaning": "æŒ‘æˆ˜",
    "example": "Face the challenge bravely.",
    "difficulty": "medium"
  }
]`
            };
            
            try {
                // æ£€æŸ¥ç¼“å­˜
                if (wordGenerationCache[cacheKey]) {
                    console.log('ä½¿ç”¨ç¼“å­˜çš„å•è¯ç»„');
                    return filterNewWords(wordGenerationCache[cacheKey]);
                }
                
                const content = await callKimiAPI([message], 0.3);
                console.log('AIåŸå§‹å“åº”:', content.substring(0, 200) + '...'); // è°ƒè¯•æ—¥å¿—
                
                // æ¸…ç†å¯èƒ½çš„markdownæ ‡è®°å’Œå¤šä½™å­—ç¬¦
                let cleanedContent = content.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
                
                // ä¿®å¤å¸¸è§çš„JSONæ ¼å¼é—®é¢˜
                cleanedContent = cleanedContent.replace(/,\s*]/g, ']'); // ç§»é™¤å°¾éšé€—å·
                cleanedContent = cleanedContent.replace(/,\s*}/g, '}'); // ç§»é™¤å¯¹è±¡ä¸­çš„å°¾éšé€—å·
                
                // å°è¯•è§£æJSON
                try {
                    const words = JSON.parse(cleanedContent);
                    
                    // éªŒè¯æ ¼å¼
                    if (Array.isArray(words) && words.length > 0) {
                        // ç¼“å­˜ç»“æœ
                        wordGenerationCache[cacheKey] = words;
                        
                        // è¿‡æ»¤æ‰å·²å­¦è¿‡çš„å•è¯ï¼ˆåŒé‡ä¿é™©ï¼‰
                        const filteredWords = filterNewWords(words);
                        
                        if (filteredWords.length === 0) {
                            console.warn('AIç”Ÿæˆçš„å•è¯å·²å…¨éƒ¨å­¦è¿‡ï¼Œå°è¯•è·å–å¤‡ç”¨å•è¯');
                            return getMockWords(category);
                        }
                        
                        return filteredWords.slice(0, 10).map(w => ({
                            ...w,
                            category: category,
                            nextReview: Date.now(),
                            reviewCount: 0,
                            difficultyFactor: 2.5,
                            status: 'new',
                            id: `${Date.now()}-${Math.random()}`
                        }));
                    }
                    throw new Error('è¿”å›çš„æ•°æ®æ ¼å¼ä¸æ­£ç¡®');
                } catch (error) {
                    console.error('è§£æAIè¿”å›çš„å•è¯å¤±è´¥:', error, 'å†…å®¹:', cleanedContent);
                    // é™çº§ä½¿ç”¨mockæ•°æ®
                    return getMockWords(category);
                }
            } catch (error) {
                console.error('AIç”Ÿæˆå•è¯å¤±è´¥:', error);
                // é™çº§ä½¿ç”¨mockæ•°æ®
                return getMockWords(category);
            }
        }

        // è¿‡æ»¤å·²å­¦è¿‡çš„å•è¯
        function filterNewWords(words) {
            const learnedWords = new Set(wordDatabase.map(w => w.word));
            return words.filter(w => w && w.word && !learnedWords.has(w.word));
        }

        // ä»mockæ•°æ®è·å–å•è¯ï¼ˆé™çº§æ–¹æ¡ˆï¼‰
        function getMockWords(category) {
            const words = mockWordGroups[category] || mockWordGroups.daily;
            // è¿‡æ»¤å·²å­¦è¿‡çš„å•è¯
            const learnedWords = new Set(wordDatabase.map(w => w.word));
            const newWords = words.filter(w => !learnedWords.has(w.word));
            
            if (newWords.length === 0) {
                // å¦‚æœmockæ•°æ®ä¹Ÿå­¦å®Œäº†ï¼Œæ˜¾ç¤ºæç¤º
                return [];
            }
            
            return newWords.slice(0, 10).map(w => ({
                ...w,
                category: category,
                nextReview: Date.now(),
                reviewCount: 0,
                difficultyFactor: 2.5,
                status: 'new',
                id: `${Date.now()}-${Math.random()}`
            }));
        }

        // ==================== AIå°è¯´ç”Ÿæˆï¼ˆå¢å¼ºç‰ˆï¼‰ ====================
        async function generateStory() {
            const container = document.getElementById('storyContainer');
            const statusDiv = document.getElementById('todayWordsCount');
            
            // è·å–ä»Šæ—¥å­¦ä¹ çš„å•è¯
            const todayWords = getTodayLearnedWords();
            
            // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
            statusDiv.textContent = todayWords.length;
            
            if (todayWords.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #999;">ä»Šå¤©è¿˜æ²¡æœ‰å­¦ä¹ å•è¯ï¼Œå¿«å»åˆ†ç»„å­¦ä¹ å§ï¼</div>';
                return;
            }

            container.innerHTML = '<div class="loading-indicator">ğŸ“ AIæ­£åœ¨ç”Ÿæˆæ•…äº‹<span class="typing-dots"></span></div>';
            
            // ä¸ºæ¯ä¸ªå•è¯æ·»åŠ ä¸­æ–‡é‡Šä¹‰
            const wordList = todayWords.map(w => `${w.word}ï¼ˆ${w.meaning}ï¼‰`).join(', ');
            
            try {
                const messages = [{
                    role: 'user',
                    content: `ä½ æ˜¯ä¸€åè‹±è¯­æ•™è‚²ä¸“å®¶ã€‚è¯·æ ¹æ®ä»¥ä¸‹å•è¯åˆ—è¡¨åˆ›ä½œä¸€æ®µ200-300å­—çš„è¶£å‘³çŸ­æ–‡ï¼š

å•è¯åˆ—è¡¨ï¼š${wordList}

ä¸¥æ ¼è¦æ±‚ï¼š
1. å¿…é¡»åŒ…å«æ‰€æœ‰æä¾›çš„å•è¯ï¼Œä¸”æ ¼å¼ä¸ºï¼šè‹±æ–‡å•è¯ï¼ˆä¸­æ–‡é‡Šä¹‰ï¼‰
2. æ¯ä¸ªè‹±æ–‡å•è¯åé¢å¿…é¡»ç´§è·Ÿæ‹¬å·æ ‡æ³¨ä¸­æ–‡é‡Šä¹‰
3. æƒ…èŠ‚è¦è¿è´¯æœ‰æ•…äº‹æ€§ï¼Œé€‚åˆè‹±è¯­å­¦ä¹ è€…é˜…è¯»
4. ä½¿ç”¨æ—¥å¸¸å£è¯­è¡¨è¾¾ï¼Œäººç‰©å¯¹è¯è‡ªç„¶
5. éš¾åº¦é€‚ä¸­ï¼Œç¬¦åˆCEFR B1-B2æ°´å¹³
6. åœ¨æ•…äº‹æœ«å°¾åˆ—å‡ºé‡ç‚¹è¯æ±‡å›é¡¾
7. ç”¨ä¸­æ–‡å’Œè‹±æ–‡æ··åˆçš„æ–¹å¼è®²è¿°æ•…äº‹

ç¤ºä¾‹æ ¼å¼ï¼š"ä»Šå¤©ï¼Œæˆ‘è¸ä¸Šäº†ä¸€æ®µæ–°çš„journeyï¼ˆæ—…ç¨‹ï¼‰ï¼Œå‡†å¤‡è¿æ¥æœªçŸ¥çš„challengeï¼ˆæŒ‘æˆ˜ï¼‰ã€‚"

è¯·ä»¥HTMLæ ¼å¼è¿”å›ï¼Œé€‚å½“ä½¿ç”¨<strong>æ ‡ç­¾çªå‡ºå…³é”®è¯ã€‚ä¸è¦æœ‰ä»»ä½•å…¶ä»–å‰ç¼€æˆ–è¯´æ˜æ–‡å­—ã€‚`
                }];
                
                const storyHTML = await callKimiAPI(messages, 0.7);
                console.log('AIå°è¯´å“åº”:', storyHTML.substring(0, 100) + '...'); // è°ƒè¯•
                
                // éªŒè¯å“åº”ä¸ä¸ºç©º
                if (!storyHTML || storyHTML.trim().length === 0) {
                    throw new Error('AIè¿”å›å†…å®¹ä¸ºç©º');
                }
                
                // æ£€æŸ¥æ˜¯å¦åŒ…å«ä¸­æ–‡æ ‡æ³¨
                if (!storyHTML.includes('ï¼ˆ') || !storyHTML.includes('ï¼‰')) {
                    console.warn('AIè¿”å›çš„å†…å®¹å¯èƒ½ä¸åŒ…å«ä¸­æ–‡æ ‡æ³¨ï¼Œå°è¯•ä¿®å¤');
                }
                
                container.innerHTML = storyHTML;
                
            } catch (error) {
                console.error('å°è¯´ç”Ÿæˆå¤±è´¥:', error);
                container.innerHTML = `
                    <div class="error-message">
                        <strong>æ•…äº‹ç”Ÿæˆå¤±è´¥</strong><br>
                        ${error.message}<br>
                        <small>è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ç¨åå†è¯•</small>
                    </div>
                    <div style="text-align: center; margin-top: 20px;">
                        <button class="btn btn-primary" onclick="generateStory()">é‡æ–°ç”Ÿæˆ</button>
                    </div>
                `;
                
                // é™çº§ï¼šæ˜¾ç¤ºç®€å•æ•…äº‹
                showSimpleStory(todayWords);
            }
        }

        // é™çº§æ˜¾ç¤ºç®€å•æ•…äº‹
        function showSimpleStory(words) {
            const container = document.getElementById('storyContainer');
            if (words.length === 0) return;
            
            const wordTexts = words.map(w => `<strong>${w.word}</strong>ï¼ˆ${w.meaning}ï¼‰`).join('ã€');
            
            const simpleStory = `
                <div style="margin: 20px 0; line-height: 2; padding: 20px; background: #f9f9f9; border-radius: 10px;">
                    <h3>ğŸ“– ä»Šæ—¥æ‰€å­¦å•è¯å›é¡¾</h3>
                    <p>ä»Šå¤©ï¼Œæˆ‘å­¦ä¹ äº†è¿™äº›é‡è¦çš„å•è¯ï¼š${wordTexts}ã€‚</p>
                    <p>æ¯ä¸€ä¸ª<strong>å•è¯ï¼ˆwordï¼‰</strong>éƒ½æœ‰å®ƒç‹¬ç‰¹çš„æ„æ€å’Œç”¨æ³•ã€‚</p>
                    <p>é€šè¿‡ä¸æ–­çš„<strong>ç»ƒä¹ ï¼ˆpracticeï¼‰</strong>ï¼Œæˆ‘ä»¬å¯ä»¥æ›´å¥½åœ°æŒæ¡å®ƒä»¬ã€‚</p>
                    <p>è®°ä½ï¼Œ<strong>åšæŒï¼ˆpersistenceï¼‰</strong>æ˜¯æˆåŠŸçš„å…³é”®ï¼</p>
                    <div style="margin-top: 20px; padding: 15px; background: #e3f2fd; border-radius: 8px;">
                        <strong>ğŸ’¡ æç¤ºï¼š</strong>AIæœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¿™æ˜¯è‡ªåŠ¨ç”Ÿæˆçš„ç®€åŒ–æ•…äº‹ã€‚è¯·ç¨åå†è¯•AIç”ŸæˆåŠŸèƒ½ã€‚
                    </div>
                </div>
            `;
            
            // å°†ç®€å•æ•…äº‹æ·»åŠ åˆ°é”™è¯¯æç¤ºä¸‹æ–¹
            container.insertAdjacentHTML('beforeend', simpleStory);
        }

        // æ›´æ–°å­¦ä¹ çŠ¶æ€æ˜¾ç¤º
        function updateLearningStatus() {
            document.getElementById('learnedCount').textContent = wordDatabase.length;
            document.getElementById('currentDifficulty').textContent = difficultyLevelText(difficultyLevel);
        }

        // ==================== åˆå§‹åŒ– ====================
        document.addEventListener('DOMContentLoaded', function() {
            // ä»è®¾ç½®ä¸­åŠ è½½éš¾åº¦çº§åˆ«
            difficultyLevel = settings.difficultyLevel || 'cet4';
            
            // åˆå§‹åŒ–éš¾åº¦é€‰æ‹©å™¨
            document.querySelectorAll('.difficulty-btn').forEach(btn => {
                if (btn.dataset.difficulty === difficultyLevel) {
                    btn.classList.add('active');
                }
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.difficulty-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    difficultyLevel = this.dataset.difficulty;
                    settings.difficultyLevel = difficultyLevel;
                    localStorage.setItem('settings', JSON.stringify(settings));
                    updateLearningStatus();
                    // è‡ªåŠ¨åŠ è½½æ–°éš¾åº¦çš„å•è¯
                    loadNewWordGroup();
                });
            });
            
            initializeApp();
            generateProgressIndicator();
            loadNewWordGroup();
            updateProgressStats();
            updateDailyProgress();
            updateLearningStatus();
            setupNotification();
        });

        function initializeApp() {
            // è·¯ç”±åˆ‡æ¢
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const page = this.dataset.page;
                    switchPage(page);
                });
            });

            // åˆ†ç±»åˆ‡æ¢
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentCategory = this.dataset.category;
                    loadNewWordGroup();
                });
            });

            // AIæ ‡ç­¾åˆ‡æ¢
            document.querySelectorAll('.ai-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    document.querySelectorAll('.ai-tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    const tabName = this.dataset.tab;
                    document.getElementById('dialogueTab').style.display = tabName === 'dialogue' ? 'block' : 'none';
                    document.getElementById('storyTab').style.display = tabName === 'story' ? 'block' : 'none';
                    
                    if (tabName === 'story') {
                        updateTodayWordsCount();
                    }
                });
            });

            // ç­›é€‰å™¨
            document.getElementById('searchInput').addEventListener('input', filterVocabulary);
            document.getElementById('filterCategory').addEventListener('change', filterVocabulary);
            document.getElementById('filterDifficulty').addEventListener('change', filterVocabulary);

            // è¯­é€Ÿè°ƒèŠ‚
            document.getElementById('rateSlider').addEventListener('input', function() {
                document.getElementById('rateValue').textContent = this.value + 'x';
                settings.rate = parseFloat(this.value);
                localStorage.setItem('settings', JSON.stringify(settings));
            });

            // åˆå§‹åŒ–å›¾è¡¨
            if (typeof Chart !== 'undefined') {
                initChart();
            }
        }

        function updateTodayWordsCount() {
            const today = new Date().toISOString().split('T')[0];
            const count = studyRecords[today] || 0;
            document.getElementById('todayWordsCount').textContent = count;
        }

        function switchPage(pageName) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            
            document.getElementById(pageName).classList.add('active');
            document.querySelector(`[data-page="${pageName}"]`).classList.add('active');

            if (pageName === 'vocabulary') {
                renderVocabulary();
            } else if (pageName === 'review') {
                updateReviewCount();
            } else if (pageName === 'progress') {
                updateProgressStats();
            }
        }

        // ==================== å•è¯å­¦ä¹  ====================
        async function loadNewWordGroup() {
            // å…ˆæ˜¾ç¤ºåŠ è½½çŠ¶æ€
            document.getElementById('wordCard').innerHTML = `
                <div class="loading-indicator" style="padding: 60px;">
                    ğŸ¤– AIæ­£åœ¨ç”Ÿæˆå•è¯ç»„<span class="typing-dots"></span>
                    <br><small>éš¾åº¦ï¼š${difficultyLevelText(difficultyLevel)} | åˆ†ç±»ï¼š${categoryText(currentCategory)}</small>
                    <br><small>å·²è¿‡æ»¤ ${wordDatabase.length} ä¸ªå·²å­¦å•è¯</small>
                </div>
            `;
            document.querySelector('.btn-group').style.display = 'none';
            
            // AIç”Ÿæˆå•è¯
            currentGroup = await generateNewWordGroup(currentCategory, difficultyLevel);
            
            // å¦‚æœAIç”Ÿæˆå¤±è´¥æˆ–æ²¡æœ‰æ–°å•è¯
            if (currentGroup.length === 0) {
                document.getElementById('wordCard').innerHTML = `
                    <div style="padding: 60px 20px; text-align: center;">
                        <h2>ğŸ‰ æ­å–œï¼æˆ–æç¤º</h2>
                        <div id="noWordsMessage">
                            <p>å½“å‰åˆ†ç±»ä¸‹${difficultyLevelText(difficultyLevel)}éš¾åº¦çš„å•è¯å·²å…¨éƒ¨å­¦å®Œï¼</p>
                            <p>è¯·é€‰æ‹©ï¼š1) åˆ‡æ¢æ›´é«˜éš¾åº¦ 2) é€‰æ‹©å…¶ä»–åˆ†ç±» 3) æŸ¥çœ‹å•è¯åº“</p>
                            <button class="btn btn-primary" onclick="switchPage('vocabulary')">æŸ¥çœ‹å•è¯åº“</button>
                        </div>
                    </div>
                `;
                return;
            }
            
            currentWordIndex = 0;
            document.getElementById('nextGroupBtn').style.display = 'none';
            showCurrentWord();
            document.querySelector('.btn-group').style.display = 'flex';
            updateLearningStatus();
        }

        function showCurrentWord() {
            if (currentWordIndex >= currentGroup.length) {
                document.getElementById('wordCard').innerHTML = `
                    <div style="padding: 60px 20px; text-align: center;">
                        <h2>ğŸ‰ æœ¬ç»„å­¦ä¹ å®Œæˆï¼</h2>
                        <p>10ä¸ªå•è¯å·²åŠ å…¥ä½ çš„å•è¯åº“</p>
                        <button class="btn btn-primary" onclick="loadNewWordGroup()">å­¦ä¹ æ–°ä¸€ç»„</button>
                    </div>
                `;
                document.querySelector('.btn-group').style.display = 'none';
                groupCompleted();
                return;
            }

            const word = currentGroup[currentWordIndex];
            document.getElementById('wordTitle').textContent = word.word;
            document.getElementById('phonetic').textContent = word.phonetic || '/Ëˆ' + word.word.toLowerCase() + '/';
            document.getElementById('wordMeaning').textContent = word.meaning;
            document.getElementById('wordExample').textContent = word.example || `This is a sample sentence with ${word.word}.`;
            
            const badge = document.getElementById('difficultyBadge');
            badge.textContent = (word.difficulty || 'easy').toUpperCase();
            badge.className = `difficulty-badge difficulty-${word.difficulty || 'easy'}`;

            if (settings.autoSpeak) {
                setTimeout(() => speakWord(), 500);
            }

            updateProgressIndicator();
        }

        function markWord(status) {
            const word = currentGroup[currentWordIndex];
            word.status = status;
            
            if (status === 'known') {
                // æ·»åŠ åˆ°å•è¯åº“
                const existingIndex = wordDatabase.findIndex(w => w.word === word.word);
                if (existingIndex === -1) {
                    wordDatabase.push({...word});
                    localStorage.setItem('wordDatabase', JSON.stringify(wordDatabase));
                    
                    // æ›´æ–°å­¦ä¹ è®°å½•
                    const today = new Date().toISOString().split('T')[0];
                    studyRecords[today] = (studyRecords[today] || 0) + 1;
                    localStorage.setItem('studyRecords', JSON.stringify(studyRecords));
                    
                    updateDailyProgress();
                    updateLearningStatus();
                }
            }

            currentWordIndex++;
            showCurrentWord();
        }

        function groupCompleted() {
            setTimeout(() => {
                switchPage('review');
            }, 2000);
        }

        // ==================== å‘éŸ³åŠŸèƒ½ ====================
        function speakWord() {
            if (currentWordIndex < currentGroup.length) {
                speak(currentGroup[currentWordIndex].word);
            }
        }

        function speakExample() {
            if (currentWordIndex < currentGroup.length) {
                speak(currentGroup[currentWordIndex].example);
            }
        }

        function speak(text) {
            if (!synth) return;
            
            synth.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = settings.voice === 'UK' ? 'en-GB' : 'en-US';
            utterance.rate = settings.rate;
            utterance.pitch = 1;
            synth.speak(utterance);
        }

        // ==================== AIè¾…åŠ©åŠŸèƒ½ ====================
        async function showAIDictionary() {
            if (currentWordIndex >= currentGroup.length) return;
            
            const word = currentGroup[currentWordIndex].word;
            
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; right: 0; bottom: 0; 
                background: rgba(0,0,0,0.5); display: flex; 
                justify-content: center; align-items: center; z-index: 1000;
            `;
            modal.innerHTML = `
                <div style="background: white; padding: 30px; border-radius: 15px; max-width: 600px; max-height: 80vh; overflow-y: auto;">
                    <h3>ğŸ” AIè¯å…¸ - ${word}</h3>
                    <div id="dictionaryContent" style="margin: 20px 0;">
                        <div style="text-align: center; color: #999;">ğŸ¤– AIæ­£åœ¨æŸ¥è¯¢ä¸­<span class="typing-dots"></span></div>
                    </div>
                    <button class="btn btn-primary" onclick="this.parentElement.parentElement.remove()">å…³é—­</button>
                </div>
            `;
            document.body.appendChild(modal);
            
            try {
                const messages = [{
                    role: 'user',
                    content: `è¯·æä¾›å•è¯"${word}"çš„è¯¦ç»†ä¿¡æ¯ï¼ŒåŒ…æ‹¬ï¼š
1. åŸºæœ¬é‡Šä¹‰
2. 3-5ä¸ªå¸¸ç”¨åŒä¹‰è¯åŠå…¶åŒºåˆ«
3. 3-5ä¸ªå¸¸ç”¨åä¹‰è¯
4. è¯¦ç»†ç”¨æ³•è¯´æ˜å’Œæ­é…å»ºè®®
5. 2-3ä¸ªå®ç”¨ä¾‹å¥

è¯·ç”¨ä¸­æ–‡å›ç­”ï¼Œæ ¼å¼æ¸…æ™°æ˜“è¯»ã€‚`
                }];
                
                const content = await callKimiAPI(messages, 0.3);
                document.getElementById('dictionaryContent').innerHTML = `<div style="line-height: 1.8;">${content.replace(/\n/g, '<br>')}</div>`;
            } catch (error) {
                document.getElementById('dictionaryContent').innerHTML = `
                    <div class="error-message">
                        æŸ¥è¯¢å¤±è´¥: ${error.message}<br>
                        <small>è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ç¨åå†è¯•</small>
                    </div>
                `;
            }
        }

        async function sendChat() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            if (!message) return;

            addChatMessage(message, 'user');
            input.value = '';
            
            const typingIndicator = document.createElement('div');
            typingIndicator.className = 'chat-message ai';
            typingIndicator.id = 'typingIndicator';
            typingIndicator.innerHTML = 'AIæ­£åœ¨æ€è€ƒ<span class="typing-dots">...</span>';
            document.getElementById('chatContainer').appendChild(typingIndicator);
            document.getElementById('chatContainer').scrollTop = document.getElementById('chatContainer').scrollHeight;

            try {
                const learnedWords = wordDatabase.slice(-20).map(w => w.word);
                
                const messages = [{
                    role: 'system',
                    content: `ä½ æ˜¯ä¸€ä½å‹å¥½çš„AIè‹±è¯­é™ªç»ƒä¼™ä¼´ã€‚ç”¨æˆ·å·²ç»å­¦ä¹ äº†è¿™äº›å•è¯ï¼š${learnedWords.join(', ')}

è¯·éµå¾ªä»¥ä¸‹è§„åˆ™ï¼š
1. ä¸»åŠ¨å‘èµ·å¯¹è¯ï¼Œåœ¨å¯¹è¯ä¸­è‡ªç„¶åœ°ä½¿ç”¨è¿™äº›å•è¯ï¼ˆè‡³å°‘5ä¸ªï¼‰
2. å¯¹è¯è¦ç®€çŸ­å‹å¥½ï¼Œé€‚åˆåˆå­¦è€…ç†è§£
3. å¦‚æœç”¨æˆ·å›å¤ä¸”æœ‰è¯­æ³•é”™è¯¯ï¼Œè¯·ç”¨ç®€å•æ–¹å¼çº æ­£
4. ä¿æŒå¯¹è¯è¿è´¯ï¼Œé¼“åŠ±ç”¨æˆ·å¤šç”¨è‹±è¯­å›å¤
5. ç”¨è‹±æ–‡å›å¤ï¼Œä½†ç¡®ä¿éš¾åº¦é€‚ä¸­`
                }, {
                    role: 'user',
                    content: message
                }];
                
                const response = await callKimiAPI(messages, 0.7);
                typingIndicator.remove();
                addChatMessage(response, 'ai');
            } catch (error) {
                typingIndicator.remove();
                addChatMessage('æŠ±æ­‰ï¼Œæˆ‘é‡åˆ°äº†ä¸€äº›é—®é¢˜ã€‚è¯·ç¨åå†è¯•ã€‚', 'ai');
                console.error('å¯¹è¯ç”Ÿæˆå¤±è´¥:', error);
            }
        }

        function addChatMessage(text, sender) {
            const container = document.getElementById('chatContainer');
            const msg = document.createElement('div');
            msg.className = `chat-message ${sender}`;
            msg.textContent = text;
            container.appendChild(msg);
            container.scrollTop = container.scrollHeight;
        }

        // ==================== é—´éš”é‡å¤ç®—æ³• ====================
        function calculateNextReview(word, quality) {
            if (!word.reviewCount) {
                word.reviewCount = 0;
                word.difficultyFactor = 2.5;
            }

            word.reviewCount++;
            
            if (quality >= 3) {
                if (word.reviewCount === 1) {
                    word.nextReview = Date.now() + 1 * 24 * 60 * 60 * 1000;
                } else if (word.reviewCount === 2) {
                    word.nextReview = Date.now() + 6 * 24 * 60 * 60 * 1000;
                } else {
                    const days = Math.round(word.difficultyFactor * (word.reviewCount === 3 ? 1 : word.difficultyFactor));
                    word.nextReview = Date.now() + days * 24 * 60 * 60 * 1000;
                }
            } else {
                word.reviewCount = 0;
                word.nextReview = Date.now() + 1 * 60 * 60 * 1000;
                word.disabled = true;
            }

            word.difficultyFactor = Math.max(1.3, word.difficultyFactor + (0.1 - (5 - quality) * (0.08 + (5 - quality) * 0.02)));
            return word;
        }

        // ==================== æ™ºèƒ½å¤ä¹  ====================
        async function generateReviewOptions(word) {
            try {
                const messages = [{
                    role: 'user',
                    content: `ä¸ºå•è¯"${word.word}"ç”Ÿæˆ3ä¸ªå¹²æ‰°é€‰é¡¹ï¼Œç”¨äºè‹±è¯­æµ‹è¯•é¢˜ã€‚

è¦æ±‚ï¼š
- æ­£ç¡®ç­”æ¡ˆæ˜¯ä¸­æ–‡é‡Šä¹‰ï¼š"${word.meaning}"
- ç”Ÿæˆ3ä¸ªä¸­æ–‡å¹²æ‰°é¡¹ï¼Œéœ€ä¸æ­£ç¡®ç­”æ¡ˆåœ¨è¯ä¹‰ã€è¯æ€§æˆ–æ‹¼å†™ä¸Šç›¸ä¼¼ï¼Œå…·æœ‰è¿·æƒ‘æ€§
- å¹²æ‰°é¡¹å¿…é¡»æ˜¯**ä¸­æ–‡**ï¼Œä¸èƒ½æ˜¯è‹±æ–‡
- è¿”å›ä¸¥æ ¼çš„JSONæ ¼å¼ï¼š{"correct":"æ­£ç¡®çš„ä¸­æ–‡é‡Šä¹‰","distractors":["ä¸­æ–‡å¹²æ‰°1","ä¸­æ–‡å¹²æ‰°2","ä¸­æ–‡å¹²æ‰°3"]}
- ä¸è¦æœ‰ä»»ä½•é¢å¤–æ–‡æœ¬ã€æ³¨é‡Šæˆ–markdownæ ¼å¼`
                }];
                
                const content = await callKimiAPI(messages, 0.3);
                console.log('å¹²æ‰°é¡¹APIå“åº”:', content.substring(0, 100)); // è°ƒè¯•
                
                // æ¸…ç†å’Œè§£æJSON
                let cleanedContent = content.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
                
                try {
                    const parsed = JSON.parse(cleanedContent);
                    const correct = parsed.correct || word.meaning;
                    const distractors = (parsed.distractors || []).slice(0, 3).map(d => d.trim());
                    
                    // ç¡®ä¿æœ‰3ä¸ªå¹²æ‰°é¡¹
                    while (distractors.length < 3) {
                        distractors.push(`é€‰é¡¹${distractors.length + 1}`);
                    }
                    
                    return [correct, ...distractors];
                } catch (error) {
                    console.error('è§£æå¹²æ‰°é¡¹å¤±è´¥:', error, 'å†…å®¹:', cleanedContent);
                    return generateFallbackOptions(word.meaning);
                }
            } catch (error) {
                console.error('å¹²æ‰°é¡¹ç”Ÿæˆå¤±è´¥:', error);
                return generateFallbackOptions(word.meaning);
            }
        }

        function startReview() {
            updateReviewQueue();
            
            if (reviewQueue.length === 0) {
                document.getElementById('reviewArea').innerHTML = `
                    <div style="text-align: center; color: #999; padding: 100px 20px;">
                        ğŸ‰ æ­å–œï¼ä»Šæ—¥å¤ä¹ å·²å®Œæˆ
                        <br><br>
                        <button class="btn btn-primary" onclick="startReview()">åˆ·æ–°å¤ä¹ é˜Ÿåˆ—</button>
                    </div>
                `;
                return;
            }

            showReviewWord();
        }

        async function showReviewWord() {
            if (reviewQueue.length === 0) {
                startReview();
                return;
            }

            currentReviewWord = reviewQueue.shift();
            
            document.getElementById('reviewArea').innerHTML = `
                <div class="loading-indicator">ğŸ¤– æ­£åœ¨ç”Ÿæˆå¤ä¹ é¢˜ç›®<span class="typing-dots"></span></div>
            `;
            
            const options = await generateReviewOptions(currentReviewWord);
            
            // ç¡®ä¿æ­£ç¡®ç­”æ¡ˆåœ¨é€‰é¡¹ä¸­
            if (!options.includes(currentReviewWord.meaning)) {
                options[0] = currentReviewWord.meaning;
            }
            
            const shuffled = options.sort(() => Math.random() - 0.5);
            const finalCorrectIndex = shuffled.indexOf(currentReviewWord.meaning);

            const html = `
                <div class="review-card">
                    <div class="review-question">${currentReviewWord.word}</div>
                    <div class="review-options" id="reviewOptions">
                        ${shuffled.map((opt, i) => `
                            <div class="review-option" onclick="selectReviewOption(${i === finalCorrectIndex ? 'true' : 'false'})">
                                ${opt}
                            </div>
                        `).join('')}
                    </div>
                    <div class="pronunciation-panel" style="justify-content: center;">
                        <button class="btn btn-primary" onclick="speak('${currentReviewWord.word}')">ğŸ”Š å‘éŸ³</button>
                    </div>
                </div>
            `;
            
            document.getElementById('reviewArea').innerHTML = html;
        }

        function updateReviewQueue() {
            const now = Date.now();
            reviewQueue = wordDatabase.filter(w => {
                if (w.disabled) {
                    return (w.nextReview || 0) <= now || (w.reviewCount || 0) < 3;
                }
                return (w.nextReview || 0) <= now;
            }).sort((a, b) => (a.nextReview || 0) - (b.nextReview || 0));
        }

        function updateReviewCount() {
            updateReviewQueue();
            document.getElementById('reviewCount').textContent = reviewQueue.length;
        }

        function selectReviewOption(isCorrect) {
            const options = document.querySelectorAll('.review-option');
            options.forEach(opt => {
                opt.style.pointerEvents = 'none';
                if (opt.onclick.toString().includes('true')) {
                    opt.classList.add('correct');
                } else if (opt === event.target) {
                    opt.classList.add('incorrect');
                }
            });

            if (isCorrect) {
                calculateNextReview(currentReviewWord, 5);
                speak("Correct! Well done!");
                updateTodayReviewed();
                
                if (currentReviewWord.disabled && currentReviewWord.reviewCount >= 3) {
                    currentReviewWord.disabled = false;
                }
            } else {
                calculateNextReview(currentReviewWord, 2);
                speak("Incorrect. Let's review again.");
                
                setTimeout(() => {
                    showEnhancedReviewTip();
                }, 2000);
            }

            const index = wordDatabase.findIndex(w => w.word === currentReviewWord.word);
            if (index !== -1) {
                wordDatabase[index] = currentReviewWord;
                localStorage.setItem('wordDatabase', JSON.stringify(wordDatabase));
            }

            setTimeout(() => {
                saveReviewResult(isCorrect);
                showReviewWord();
            }, 3000);
        }

        function showEnhancedReviewTip() {
            const tip = document.createElement('div');
            tip.style.cssText = `
                background: #fff3cd;
                border: 1px solid #ffeaa7;
                border-radius: 10px;
                padding: 15px;
                margin: 20px;
            `;
            tip.innerHTML = `
                <strong>ğŸ’¡ å¼ºåŒ–è®°å¿†æç¤º</strong><br>
                "${currentReviewWord.word}" çš„æ„æ€æ˜¯ <strong>${currentReviewWord.meaning}</strong><br>
                <em>"${currentReviewWord.example}"</em>
            `;
            document.getElementById('reviewArea').appendChild(tip);
            
            setTimeout(() => tip.remove(), 3000);
        }

        function saveReviewResult(isCorrect) {
            const today = new Date().toISOString().split('T')[0];
            if (!studyRecords.review) studyRecords.review = {};
            studyRecords.review[today] = (studyRecords.review[today] || 0) + 1;
            localStorage.setItem('studyRecords', JSON.stringify(studyRecords));
        }

        function updateTodayReviewed() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('todayReviewed').textContent = studyRecords.review?.[today] || 0;
        }

        // ==================== å•è¯åº“ç®¡ç† ====================
        function renderVocabulary() {
            const container = document.getElementById('wordGrid');
            const search = document.getElementById('searchInput').value.toLowerCase();
            const categoryFilter = document.getElementById('filterCategory').value;
            const difficultyFilter = document.getElementById('filterDifficulty').value;

            let filtered = wordDatabase.filter(w => {
                if (search && !w.word.includes(search) && !w.meaning.includes(search)) return false;
                if (categoryFilter && w.category !== categoryFilter) return false;
                if (difficultyFilter && w.difficulty !== difficultyFilter) return false;
                return true;
            });

            container.innerHTML = filtered.map(word => `
                <div class="word-item">
                    <h3>${word.word} <span class="difficulty-tag tag-${word.category}">${categoryText(word.category)}</span></h3>
                    <div style="color: #666; font-size: 14px;">${word.phonetic}</div>
                    <div style="margin: 10px 0;">${word.meaning}</div>
                    <div style="font-size: 12px; color: #999;">
                        ${word.category} | ${word.difficulty}
                    </div>
                    <div class="mastery-bar">
                        <div class="mastery-fill" style="width: ${Math.min((word.reviewCount || 0) * 20, 100)}%"></div>
                    </div>
                    <div style="font-size: 12px; color: #666; margin-top: 5px;">
                        å¤ä¹ ${word.reviewCount || 0}æ¬¡
                    </div>
                    <div style="margin-top: 10px;">
                        <button class="btn btn-sm btn-primary" onclick="reviewWord('${word.word}')">å¤ä¹ </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteWord('${word.word}')">åˆ é™¤</button>
                    </div>
                </div>
            `).join('');
        }

        function filterVocabulary() {
            renderVocabulary();
        }

        function reviewWord(word) {
            switchPage('review');
            const targetWord = wordDatabase.find(w => w.word === word);
            if (targetWord) {
                reviewQueue.unshift(targetWord);
            }
        }

        function deleteWord(word) {
            if (confirm(`ç¡®å®šè¦åˆ é™¤å•è¯ "${word}" å—ï¼Ÿ`)) {
                wordDatabase = wordDatabase.filter(w => w.word !== word);
                localStorage.setItem('wordDatabase', JSON.stringify(wordDatabase));
                renderVocabulary();
                updateLearningStatus();
            }
        }

        function importCSV() {
            document.getElementById('csvFile').click();
        }

        function handleCSV(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const lines = e.target.result.split('\n');
                let imported = 0;
                
                lines.forEach(line => {
                    const parts = line.trim().split(',');
                    if (parts.length >= 5) {
                        const word = {
                            word: parts[0],
                            phonetic: parts[1],
                            meaning: parts[2],
                            example: parts[3],
                            category: parts[4],
                            difficulty: parts[5] || 'medium',
                            nextReview: Date.now(),
                            reviewCount: 0
                        };
                        
                        if (!wordDatabase.find(w => w.word === word.word)) {
                            wordDatabase.push(word);
                            imported++;
                        }
                    }
                });

                localStorage.setItem('wordDatabase', JSON.stringify(wordDatabase));
                alert(`æˆåŠŸå¯¼å…¥ ${imported} ä¸ªå•è¯ï¼`);
                renderVocabulary();
                updateLearningStatus();
            };
            reader.readAsText(file);
        }

        // ==================== è¿›åº¦ç»Ÿè®¡ ====================
        function updateProgressStats() {
            document.getElementById('totalWords').textContent = wordDatabase.length;
            
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('todayLearned').textContent = studyRecords[today] || 0;
            document.getElementById('todayReviewed').textContent = studyRecords.review?.[today] || 0;
            
            // è®¡ç®—è¿ç»­å¤©æ•°
            let streak = 0;
            let checkDate = new Date();
            while (true) {
                const dateStr = checkDate.toISOString().split('T')[0];
                if (studyRecords[dateStr] || studyRecords.review?.[dateStr]) {
                    streak++;
                    checkDate.setDate(checkDate.getDate() - 1);
                } else {
                    break;
                }
            }
            document.getElementById('streakDays').textContent = streak;
        }

        function updateDailyProgress() {
            const today = new Date().toISOString().split('T')[0];
            const todayLearned = studyRecords[today] || 0;
            const progress = Math.min((todayLearned / settings.dailyGoal) * 100, 100);
            document.getElementById('dailyProgress').style.width = progress + '%';
        }

        let progressChart = null;

        function initChart() {
            const ctx = document.getElementById('progressChart').getContext('2d');
            const last7Days = getLast7DaysData();
            
            progressChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: last7Days.dates,
                    datasets: [{
                        label: 'å­¦ä¹ å•è¯æ•°',
                        data: last7Days.learned,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4
                    }, {
                        label: 'å¤ä¹ å•è¯æ•°',
                        data: last7Days.reviewed,
                        borderColor: '#4CAF50',
                        backgroundColor: 'rgba(76, 175, 80, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'æœ€è¿‘7å¤©å­¦ä¹ è¿›åº¦'
                        }
                    }
                }
            });
        }

        function getLast7DaysData() {
            const dates = [];
            const learned = [];
            const reviewed = [];
            
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];
                const shortDate = date.toLocaleDateString('zh-CN', {month: 'short', day: 'numeric'});
                
                dates.push(shortDate);
                learned.push(studyRecords[dateStr] || 0);
                reviewed.push(studyRecords.review?.[dateStr] || 0);
            }
            
            return {dates, learned, reviewed};
        }

        function saveSettings() {
            settings.dailyGoal = parseInt(document.getElementById('dailyGoal').value);
            settings.reminderTime = document.getElementById('reminderTime').value;
            settings.autoSpeak = document.getElementById('autoSpeak').checked;
            settings.difficultyLevel = difficultyLevel;
            
            localStorage.setItem('settings', JSON.stringify(settings));
            
            // æ˜¾ç¤ºæˆåŠŸæç¤º
            const successDiv = document.createElement('div');
            successDiv.className = 'success-message';
            successDiv.textContent = 'âœ… è®¾ç½®å·²ä¿å­˜æˆåŠŸï¼';
            document.querySelector('.settings-panel').appendChild(successDiv);
            
            setTimeout(() => successDiv.remove(), 3000);
            
            updateDailyProgress();
        }

        // ==================== é€šçŸ¥åŠŸèƒ½ ====================
        function setupNotification() {
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission();
            }
            
            // è®¾ç½®æ¯æ—¥æé†’
            const [hour, minute] = settings.reminderTime.split(':');
            const reminderTime = new Date();
            reminderTime.setHours(parseInt(hour), parseInt(minute), 0, 0);
            
            if (reminderTime > new Date()) {
                const timeout = reminderTime - new Date();
                setTimeout(() => {
                    if (Notification.permission === 'granted') {
                        new Notification('AIè‹±è¯­å­¦å›­', {
                            body: 'è¯¥å¤ä¹ å•è¯å•¦ï¼ä»Šå¤©çš„å­¦ä¹ ç›®æ ‡åœ¨ç­‰ç€ä½ ï¼',
                            icon: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg=='
                        });
                    }
                }, timeout);
            }
        }

        // ==================== å·¥å…·å‡½æ•° ====================
        function generateProgressIndicator() {
            const container = document.getElementById('progressIndicator');
            container.innerHTML = '';
            for (let i = 0; i < 10; i++) {
                const dot = document.createElement('div');
                dot.className = 'progress-dot';
                container.appendChild(dot);
            }
        }

        function updateProgressIndicator() {
            const dots = document.querySelectorAll('.progress-dot');
            dots.forEach((dot, i) => {
                if (i < currentWordIndex) {
                    dot.classList.add('completed');
                } else {
                    dot.classList.remove('completed');
                }
            });
        }

        // é˜²æ­¢é¡µé¢å…³é—­æ—¶ä¸¢å¤±æ•°æ®
        window.addEventListener('beforeunload', function() {
            localStorage.setItem('wordDatabase', JSON.stringify(wordDatabase));
            localStorage.setItem('studyRecords', JSON.stringify(studyRecords));
        });
    </script>
</body>
</html>
